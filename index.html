<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aplikasi Guru Wali - Dwik Setyawan, S.Pd.</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <!-- SheetJS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- jsPDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>
    
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot, query, orderBy, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase Configuration (Environment Variables)
        const firebaseConfig = JSON.parse(__firebase_config);
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        let currentUser = null;

        // Global State Arrays
        window.students = [];
        window.journals = [];
        window.pillars = [];
        window.activities = [];
        
        // Initialize Auth & Database Listeners
        const initAuth = async () => {
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                await signInWithCustomToken(auth, __initial_auth_token);
            } else {
                await signInAnonymously(auth);
            }
        };

        initAuth();

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                console.log("Database Connected as:", user.uid);
                setupListeners(user.uid);
            }
        });

        // Setup Real-time Listeners
        function setupListeners(userId) {
            // 1. Listen for Students
            const studentRef = collection(db, 'artifacts', appId, 'users', userId, 'students');
            onSnapshot(studentRef, (snapshot) => {
                window.students = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                // Jika kosong, isi data default sekali saja
                if (window.students.length === 0 && !localStorage.getItem('dataSeeded')) {
                    seedDefaultData(userId);
                }
                renderFilterOptions();
                renderStudents();
                renderJournalDatalist();
            }, (error) => console.error("Student sync error:", error));

            // 2. Listen for Journals
            const journalRef = collection(db, 'artifacts', appId, 'users', userId, 'journals');
            onSnapshot(journalRef, (snapshot) => {
                // Sort manual karena Firestore complex query butuh index
                window.journals = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }))
                                               .sort((a, b) => new Date(b.tanggal + ' ' + b.waktu) - new Date(a.tanggal + ' ' + a.waktu));
                renderJournalRecap();
            }, (error) => console.error("Journal sync error:", error));

            // 3. Listen for Program (Pillars & Activities stored in a settings collection)
            const settingsRef = collection(db, 'artifacts', appId, 'users', userId, 'settings');
            onSnapshot(settingsRef, (snapshot) => {
                const settings = snapshot.docs.reduce((acc, doc) => ({...acc, [doc.id]: doc.data()}), {});
                
                if (settings.program) {
                    window.pillars = settings.program.pillars || [];
                    window.activities = settings.program.activities || [];
                } else {
                    // Load defaults locally if not in DB yet
                    window.pillars = defaultPillars;
                    window.activities = defaultActivities;
                }
                renderProgram();
            }, (error) => console.error("Settings sync error:", error));
        }

        // Helper to seed initial data
        async function seedDefaultData(userId) {
            const batch = writeBatch(db);
            const studentCol = collection(db, 'artifacts', appId, 'users', userId, 'students');
            
            defaultStudents.forEach(s => {
                const docRef = doc(studentCol);
                batch.set(docRef, s);
            });

            // Save default program settings
            const settingsDoc = doc(db, 'artifacts', appId, 'users', userId, 'settings', 'program');
            batch.set(settingsDoc, { pillars: defaultPillars, activities: defaultActivities });

            await batch.commit();
            localStorage.setItem('dataSeeded', 'true');
            console.log("Default data seeded to database.");
        }

        // --- EXPORTED FUNCTIONS FOR HTML ONCLICK ---
        
        // Students CRUD
        window.saveStudentDB = async (studentData, id = null, silent = false) => {
            if (!currentUser) return;
            const col = collection(db, 'artifacts', appId, 'users', currentUser.uid, 'students');
            try {
                if (id) {
                    await updateDoc(doc(col, id), studentData);
                    if (!silent) showToast('Berhasil', 'Data murid diperbarui di database.', 'success');
                } else {
                    await addDoc(col, studentData);
                    if (!silent) showToast('Berhasil', 'Data murid disimpan ke database.', 'success');
                }
                if (!silent) closeStudentModal();
            } catch (e) {
                console.error(e);
                if (!silent) showToast('Gagal', 'Terjadi kesalahan database.', 'error');
                throw e; 
            }
        };

        window.deleteStudentDB = async (id) => {
            if (!currentUser) return;
            try {
                await deleteDoc(doc(db, 'artifacts', appId, 'users', currentUser.uid, 'students', id));
                showToast('Terhapus', 'Data murid dihapus dari database.', 'success');
            } catch (e) {
                showToast('Gagal', 'Gagal menghapus data.', 'error');
            }
        };

        // NEW: Bulk Delete Function
        window.bulkDeleteStudentsDB = async (year, className) => {
            if (!currentUser) return;
            
            // Filter locally first to get IDs
            const studentsToDelete = window.students.filter(s => {
                const matchYear = year ? (s.academicYear === year) : true;
                const matchClass = className ? (s.class === className) : true;
                return matchYear && matchClass;
            });

            if (studentsToDelete.length === 0) {
                Swal.fire('Info', 'Tidak ada data murid yang sesuai kriteria.', 'info');
                return;
            }

            // Confirm again before deleting
            const result = await Swal.fire({
                title: 'Konfirmasi Hapus Massal',
                text: `Akan menghapus ${studentsToDelete.length} murid (Tahun: ${year || 'Semua'}, Kelas: ${className || 'Semua'}). Lanjutkan?`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'Ya, Hapus Semua!'
            });

            if (result.isConfirmed) {
                const batch = writeBatch(db);
                studentsToDelete.forEach(s => {
                    const docRef = doc(db, 'artifacts', appId, 'users', currentUser.uid, 'students', s.id);
                    batch.delete(docRef);
                });

                try {
                    await batch.commit();
                    showToast('Berhasil', `${studentsToDelete.length} data murid berhasil dihapus.`, 'success');
                    closeBulkDeleteModal();
                } catch (e) {
                    console.error(e);
                    showToast('Gagal', 'Gagal melakukan penghapusan massal.', 'error');
                }
            }
        };

        // Journals CRUD
        window.saveJournalDB = async (journalData, id = null) => {
            if (!currentUser) return;
            const col = collection(db, 'artifacts', appId, 'users', currentUser.uid, 'journals');
            try {
                if (id) {
                    await updateDoc(doc(col, id), journalData);
                    showToast('Berhasil', 'Jurnal diperbarui.', 'success');
                } else {
                    await addDoc(col, journalData);
                    showToast('Berhasil', 'Jurnal tersimpan.', 'success');
                }
                if(id) closeJournalModal(); 
            } catch (e) {
                console.error(e);
                showToast('Gagal', 'Gagal menyimpan jurnal.', 'error');
            }
        };

        window.deleteJournalDB = async (id) => {
            if (!currentUser) return;
            try {
                await deleteDoc(doc(db, 'artifacts', appId, 'users', currentUser.uid, 'journals', id));
                showToast('Terhapus', 'Jurnal dihapus.', 'success');
            } catch (e) {
                showToast('Gagal', 'Gagal menghapus jurnal.', 'error');
            }
        };

        // Program CRUD (Single Doc Update)
        window.saveProgramDB = async (type, dataArray) => {
            if (!currentUser) return;
            const docRef = doc(db, 'artifacts', appId, 'users', currentUser.uid, 'settings', 'program');
            try {
                // We need to merge with existing data, or set if new
                // Simplified: we just update the specific field
                await updateDoc(docRef, { [type]: dataArray }).catch(async () => {
                    // If doc doesn't exist, set it (fallback)
                    await setDoc(docRef, { pillars: window.pillars, activities: window.activities });
                });
                showToast('Berhasil', 'Program diperbarui.', 'success');
            } catch (e) {
                console.error(e);
            }
        };

    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Poppins', sans-serif; }
        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen relative overflow-x-hidden">

    <!-- Notification Toast -->
    <div id="toast" class="fixed top-5 right-5 z-[80] transform transition-all duration-300 translate-x-full opacity-0">
        <div class="bg-white border-l-4 shadow-lg rounded-lg p-4 w-72 flex items-center gap-3">
            <div id="toast-icon"></div>
            <div>
                <h4 id="toast-title" class="font-bold text-sm"></h4>
                <p id="toast-message" class="text-xs text-gray-600"></p>
            </div>
        </div>
    </div>

    <!-- Bulk Delete Modal (NEW) -->
    <div id="bulkDeleteModal" class="fixed inset-0 z-[70] hidden overflow-y-auto">
        <div class="flex items-center justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
            <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" onclick="closeBulkDeleteModal()"></div>
            <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-sm w-full">
                <div class="bg-white px-4 pt-5 pb-4 sm:p-6">
                    <div class="flex items-center gap-3 mb-4 border-b pb-2">
                        <div class="bg-red-100 p-2 rounded-full"><i data-lucide="trash-2" class="w-5 h-5 text-red-600"></i></div>
                        <h3 class="text-lg font-bold text-gray-900">Hapus Massal Murid</h3>
                    </div>
                    <p class="text-sm text-gray-500 mb-4">Pilih kriteria murid yang ingin dihapus. Tindakan ini tidak dapat dibatalkan.</p>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Tahun Ajaran</label>
                            <select id="bulkDeleteYear" class="w-full border border-gray-300 rounded-md p-2 text-sm bg-white">
                                <!-- Populated by JS -->
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Kelas</label>
                            <select id="bulkDeleteClass" class="w-full border border-gray-300 rounded-md p-2 text-sm bg-white">
                                <!-- Populated by JS -->
                            </select>
                        </div>
                    </div>
                </div>
                <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse gap-2">
                    <button onclick="confirmBulkDelete()" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-red-600 text-base font-medium text-white hover:bg-red-700 sm:w-auto sm:text-sm">Hapus Data</button>
                    <button onclick="closeBulkDeleteModal()" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 sm:mt-0 sm:w-auto sm:text-sm">Batal</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Student Modal -->
    <div id="studentModal" class="fixed inset-0 z-[60] hidden overflow-y-auto">
        <div class="flex items-center justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
            <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" onclick="closeStudentModal()"></div>
            <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg w-full">
                <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                    <div class="sm:flex sm:items-start">
                        <div class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-pink-100 sm:mx-0 sm:h-10 sm:w-10">
                            <i data-lucide="user-plus" class="h-6 w-6 text-pink-600"></i>
                        </div>
                        <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left w-full">
                            <h3 class="text-lg leading-6 font-medium text-gray-900" id="modal-title">Form Data Murid</h3>
                            <div class="mt-4 space-y-3">
                                <input type="hidden" id="studentId"> <!-- Changed from index to ID -->
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Foto Murid</label>
                                    <div class="flex items-center gap-4">
                                        <div class="w-16 h-16 rounded-full overflow-hidden bg-gray-100 border border-gray-200 flex-shrink-0 relative">
                                            <img id="studentPhotoPreview" src="" class="w-full h-full object-cover hidden">
                                            <div id="studentPhotoPlaceholder" class="w-full h-full flex items-center justify-center text-gray-400">
                                                <i data-lucide="camera" class="w-6 h-6"></i>
                                            </div>
                                        </div>
                                        <input type="file" id="studentPhoto" accept="image/*" onchange="previewImage(this)" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-xs file:font-semibold file:bg-pink-50 file:text-pink-700 hover:file:bg-pink-100 cursor-pointer">
                                    </div>
                                    <p class="text-[10px] text-gray-500 mt-1">*Format: JPG/PNG, Maksimal ukuran: 500KB</p>
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Tahun Ajaran</label>
                                    <input type="text" id="studentAcademicYear" list="academicYearOptions" placeholder="Contoh: 2024/2025" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-pink-500 focus:border-pink-500">
                                    <datalist id="academicYearOptions">
                                        <option value="2023/2024">
                                        <option value="2024/2025">
                                        <option value="2025/2026">
                                    </datalist>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">NISN</label>
                                    <input type="number" id="studentNisn" placeholder="Nomor Induk Siswa Nasional" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-pink-500 focus:border-pink-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Nama Lengkap</label>
                                    <input type="text" id="studentName" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-pink-500 focus:border-pink-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Kelas</label>
                                    <input type="text" id="studentClass" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-pink-500 focus:border-pink-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">No. HP / WA</label>
                                    <input type="text" id="studentPhone" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-pink-500 focus:border-pink-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Alamat</label>
                                    <textarea id="studentAddress" rows="2" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-pink-500 focus:border-pink-500"></textarea>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                    <button type="button" id="btnSaveStudent" onclick="saveStudent()" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-[#FF78F0] text-base font-medium text-white hover:bg-pink-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-pink-500 sm:ml-3 sm:w-auto sm:text-sm">Simpan</button>
                    <button type="button" onclick="closeStudentModal()" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">Batal</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Journal Edit Modal -->
    <div id="journalModal" class="fixed inset-0 z-[60] hidden overflow-y-auto">
        <div class="flex items-center justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
            <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" onclick="closeJournalModal()"></div>
            <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-2xl w-full">
                <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                    <div class="sm:flex sm:items-start">
                        <div class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-emerald-100 sm:mx-0 sm:h-10 sm:w-10">
                            <i data-lucide="edit-3" class="h-6 w-6 text-emerald-600"></i>
                        </div>
                        <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left w-full">
                            <h3 class="text-lg leading-6 font-medium text-gray-900" id="journal-modal-title">Edit Data Jurnal</h3>
                            <div class="mt-4 space-y-3 md:grid md:grid-cols-2 md:gap-4 md:space-y-0">
                                <input type="hidden" id="editJournalId"> <!-- Changed to ID -->
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Tanggal</label>
                                    <input type="date" id="editJournalDate" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-emerald-500 focus:border-emerald-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Waktu</label>
                                    <input type="time" id="editJournalTime" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-emerald-500 focus:border-emerald-500">
                                </div>
                                <div class="md:col-span-2">
                                    <label class="block text-sm font-medium text-gray-700">Nama Murid</label>
                                    <input type="text" id="editJournalName" list="dynamic_student_list_modal" oninput="syncStudentData('editJournal')" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-emerald-500 focus:border-emerald-500">
                                    <datalist id="dynamic_student_list_modal"></datalist>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Kelas</label>
                                    <input type="text" id="editJournalClass" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-emerald-500 focus:border-emerald-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Tahun Ajaran</label>
                                    <input type="text" id="editJournalAcademicYear" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-emerald-500 focus:border-emerald-500">
                                </div>
                                <div class="md:col-span-2">
                                    <label class="block text-sm font-medium text-gray-700">Jenis Bimbingan</label>
                                    <select id="editJournalType" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-emerald-500 focus:border-emerald-500 bg-white">
                                        <option value="Pendampingan Akademik">Pendampingan Akademik</option>
                                        <option value="Pengembangan Kompetensi">Pengembangan Kompetensi</option>
                                        <option value="Pengembangan Keterampilan">Pengembangan Keterampilan</option>
                                        <option value="Pembentukan Karakter">Pembentukan Karakter</option>
                                    </select>
                                </div>
                                <div class="md:col-span-2">
                                    <label class="block text-sm font-medium text-gray-700">Topik</label>
                                    <textarea id="editJournalTopic" rows="2" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-emerald-500 focus:border-emerald-500"></textarea>
                                </div>
                                <div class="md:col-span-2">
                                    <label class="block text-sm font-medium text-gray-700">Tindak Lanjut</label>
                                    <textarea id="editJournalAction" rows="2" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-emerald-500 focus:border-emerald-500"></textarea>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                    <button onclick="saveJournalEdit()" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-[#10B981] text-base font-medium text-white hover:bg-emerald-600 sm:ml-3 sm:w-auto sm:text-sm">Update</button>
                    <button onclick="closeJournalModal()" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">Batal</button>
                </div>
            </div>
        </div>
    </div>

    <!-- PDF Settings Modal -->
    <div id="pdfSettingsModal" class="fixed inset-0 z-[70] hidden overflow-y-auto">
        <div class="flex items-center justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
            <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" onclick="closePdfSettings()"></div>
            <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-sm w-full">
                <div class="bg-white px-4 pt-5 pb-4 sm:p-6">
                    <h3 class="text-lg font-bold text-gray-900 mb-4">Pengaturan PDF</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-xs font-semibold text-gray-600 uppercase mb-1">Ukuran Kertas</label>
                            <select id="pdfSize" class="w-full border border-gray-300 rounded p-2 text-sm bg-white">
                                <option value="a4">A4 (210 x 297 mm)</option>
                                <option value="f4">F4 / Folio (215 x 330 mm)</option>
                                <option value="legal">Legal (216 x 356 mm)</option>
                                <option value="letter">Letter (216 x 279 mm)</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs font-semibold text-gray-600 uppercase mb-1">Orientasi</label>
                            <div class="flex gap-2">
                                <label class="flex-1 cursor-pointer">
                                    <input type="radio" name="pdfOrientation" value="portrait" class="peer hidden">
                                    <div class="border border-gray-300 rounded p-2 text-center text-sm peer-checked:bg-emerald-100 peer-checked:border-emerald-500 peer-checked:text-emerald-700 hover:bg-gray-50 transition">Potret</div>
                                </label>
                                <label class="flex-1 cursor-pointer">
                                    <input type="radio" name="pdfOrientation" value="landscape" class="peer hidden" checked>
                                    <div class="border border-gray-300 rounded p-2 text-center text-sm peer-checked:bg-emerald-100 peer-checked:border-emerald-500 peer-checked:text-emerald-700 hover:bg-gray-50 transition">Lanskap</div>
                                </label>
                            </div>
                        </div>
                        <div>
                            <label class="block text-xs font-semibold text-gray-600 uppercase mb-1">Margin (mm)</label>
                            <div class="grid grid-cols-2 gap-2">
                                <div><span class="text-[10px] text-gray-400">Atas</span><input type="number" id="pdfMarginTop" value="15" class="w-full border p-1 rounded text-sm"></div>
                                <div><span class="text-[10px] text-gray-400">Kanan</span><input type="number" id="pdfMarginRight" value="15" class="w-full border p-1 rounded text-sm"></div>
                                <div><span class="text-[10px] text-gray-400">Bawah</span><input type="number" id="pdfMarginBottom" value="15" class="w-full border p-1 rounded text-sm"></div>
                                <div><span class="text-[10px] text-gray-400">Kiri</span><input type="number" id="pdfMarginLeft" value="15" class="w-full border p-1 rounded text-sm"></div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="bg-gray-50 px-4 py-3 sm:px-6 flex justify-end">
                    <button onclick="closePdfSettings()" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-[#10B981] text-base font-medium text-white hover:bg-emerald-600 sm:text-sm">Simpan Pengaturan</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Pillar & Activity Modals -->
    <div id="pillarModal" class="fixed inset-0 z-[60] hidden overflow-y-auto">
        <!-- Content same as previous, logic handled by openPillarModal -->
        <div class="flex items-center justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
            <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" onclick="closePillarModal()"></div>
            <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-md w-full">
                <div class="bg-white px-4 pt-5 pb-4 sm:p-6">
                    <h3 id="pillarModalTitle" class="text-lg font-medium text-gray-900 mb-4">Edit Pilar</h3>
                    <input type="hidden" id="pillarIndex">
                    <div class="space-y-3">
                        <div><label class="block text-sm font-medium text-gray-700">Nama Pilar</label><input type="text" id="pillarName" class="mt-1 block w-full border border-gray-300 rounded-md p-2"></div>
                        <div><label class="block text-sm font-medium text-gray-700">Ikon</label><select id="pillarIcon" class="mt-1 block w-full border border-gray-300 rounded-md p-2 bg-white"><option value="book">Book</option><option value="award">Award</option><option value="pen-tool">Pen Tool</option><option value="heart">Heart</option><option value="star">Star</option><option value="users">Users</option><option value="lightbulb">Lightbulb</option><option value="target">Target</option></select></div>
                    </div>
                </div>
                <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                    <button onclick="savePillar()" class="w-full inline-flex justify-center rounded-md bg-[#A31ACB] px-4 py-2 text-white hover:bg-purple-600 sm:ml-3 sm:w-auto sm:text-sm">Simpan</button>
                    <button onclick="closePillarModal()" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 px-4 py-2 bg-white hover:bg-gray-50 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">Batal</button>
                </div>
            </div>
        </div>
    </div>

    <div id="activityModal" class="fixed inset-0 z-[60] hidden overflow-y-auto">
        <div class="flex items-center justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
            <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" onclick="closeActivityModal()"></div>
            <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-md w-full">
                <div class="bg-white px-4 pt-5 pb-4 sm:p-6">
                    <h3 id="activityModalTitle" class="text-lg font-medium text-gray-900 mb-4">Edit Kegiatan</h3>
                    <input type="hidden" id="activityIndex">
                    <div><label class="block text-sm font-medium text-gray-700">Deskripsi Kegiatan</label><textarea id="activityDesc" rows="4" class="mt-1 block w-full border border-gray-300 rounded-md p-2"></textarea></div>
                </div>
                <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                    <button onclick="saveActivity()" class="w-full inline-flex justify-center rounded-md bg-[#A31ACB] px-4 py-2 text-white hover:bg-purple-600 sm:ml-3 sm:w-auto sm:text-sm">Simpan</button>
                    <button onclick="closeActivityModal()" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 px-4 py-2 bg-white hover:bg-gray-50 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">Batal</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Landing Page -->
    <section id="page-landing" class="flex items-center justify-center min-h-screen p-4">
        <div class="w-full max-w-md bg-[#39B5E0] rounded-2xl shadow-2xl p-8 text-center text-white fade-in relative overflow-hidden">
            <div class="absolute -top-10 -right-10 w-32 h-32 bg-white opacity-10 rounded-full"></div>
            <div class="mb-6 flex justify-center"><div class="bg-white p-4 rounded-full shadow-md text-[#39B5E0]"><i data-lucide="graduation-cap" class="w-12 h-12"></i></div></div>
            <h1 class="text-2xl font-bold mb-2">Selamat Datang</h1>
            <h2 class="text-xl font-semibold mb-1">Aplikasi Guru Wali</h2>
            <p class="text-white/90 font-medium mb-8">Dwik Setyawan, S.Pd.</p>
            <button onclick="navigateTo('page-home')" class="bg-white text-[#39B5E0] font-bold py-3 px-8 rounded-full shadow-lg hover:bg-gray-100 transform hover:scale-105 transition duration-300 flex items-center justify-center gap-2 mx-auto w-full"><span>Mulai</span><i data-lucide="arrow-right" class="w-5 h-5"></i></button>
        </div>
    </section>

    <!-- Home -->
    <section id="page-home" class="hidden min-h-screen p-4 pt-10 pb-10">
        <div class="max-w-md md:max-w-6xl mx-auto fade-in">
            <div class="bg-white p-6 rounded-2xl shadow-lg mb-8 text-center border-b-4 border-[#39B5E0]"><h2 class="text-gray-800 font-bold text-xl">Dashboard Utama</h2><p class="text-gray-500 text-sm">Silakan pilih menu di bawah ini</p></div>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                <!-- Menu Items -->
                <div onclick="navigateTo('page-program')" class="group cursor-pointer bg-[#A31ACB] p-6 rounded-2xl shadow-lg text-white transform hover:scale-105 transition duration-300 relative overflow-hidden h-40 flex flex-col justify-center"><div class="absolute top-2 right-2 opacity-20"><i data-lucide="calendar-check" class="w-16 h-16"></i></div><h3 class="text-lg font-bold z-10">Program Kegiatan</h3><p class="text-xs opacity-90 mt-1 z-10">Kelola Pilar & Bentuk Kegiatan</p><div class="mt-auto flex items-center text-sm font-semibold z-10">Buka Menu <i data-lucide="chevron-right" class="w-4 h-4 ml-1"></i></div></div>
                <div onclick="navigateTo('page-students')" class="group cursor-pointer bg-[#FF78F0] p-6 rounded-2xl shadow-lg text-white transform hover:scale-105 transition duration-300 relative overflow-hidden h-40 flex flex-col justify-center"><div class="absolute top-2 right-2 opacity-20"><i data-lucide="users" class="w-16 h-16"></i></div><h3 class="text-lg font-bold z-10">Daftar Murid</h3><p class="text-xs opacity-90 mt-1 z-10">Kelola Data & Tahun Ajaran</p><div class="mt-auto flex items-center text-sm font-semibold z-10">Buka Menu <i data-lucide="chevron-right" class="w-4 h-4 ml-1"></i></div></div>
                <div onclick="navigateTo('page-journal')" class="group cursor-pointer bg-[#F5EA5A] p-6 rounded-2xl shadow-lg text-gray-800 transform hover:scale-105 transition duration-300 relative overflow-hidden h-40 flex flex-col justify-center"><div class="absolute top-2 right-2 opacity-20 text-black"><i data-lucide="book-open" class="w-16 h-16"></i></div><h3 class="text-lg font-bold z-10">Jurnal Guru Wali</h3><p class="text-xs opacity-80 mt-1 text-gray-700 z-10">Formulir Catatan Harian</p><div class="mt-auto flex items-center text-sm font-semibold z-10">Buka Menu <i data-lucide="chevron-right" class="w-4 h-4 ml-1"></i></div></div>
                <div onclick="navigateTo('page-recap')" class="group cursor-pointer bg-[#10B981] p-6 rounded-2xl shadow-lg text-white transform hover:scale-105 transition duration-300 relative overflow-hidden h-40 flex flex-col justify-center"><div class="absolute top-2 right-2 opacity-20"><i data-lucide="clipboard-list" class="w-16 h-16"></i></div><h3 class="text-lg font-bold z-10">Rekap Jurnal</h3><p class="text-xs opacity-90 mt-1 z-10">Riwayat & Ekspor Data</p><div class="mt-auto flex items-center text-sm font-semibold z-10">Buka Menu <i data-lucide="chevron-right" class="w-4 h-4 ml-1"></i></div></div>
            </div>
            <div class="mt-12 text-center text-gray-400 text-xs">&copy; 2024 Aplikasi Guru Wali - Dwik Setyawan, S.Pd.</div>
        </div>
    </section>

    <!-- Program Page -->
    <section id="page-program" class="hidden min-h-screen p-4 pb-10">
        <div class="max-w-2xl md:max-w-6xl mx-auto fade-in">
            <div class="bg-[#A31ACB] text-white p-6 rounded-t-2xl shadow-lg flex items-center justify-between sticky top-0 z-10"><div><h2 class="font-bold text-lg">Program Kegiatan</h2><p class="text-xs opacity-90">Rencana Kerja Guru Wali</p></div><button onclick="navigateTo('page-home')" class="bg-white/20 p-2 rounded-full hover:bg-white/30"><i data-lucide="home" class="w-5 h-5"></i></button></div>
            <div class="bg-white p-6 rounded-b-2xl shadow-lg">
                <div class="flex flex-col lg:flex-row gap-8">
                    <div class="lg:w-1/3"><div class="flex justify-between items-center mb-3 border-b-2 border-[#A31ACB] pb-1"><h3 class="text-[#A31ACB] font-bold text-lg">Pilar Program</h3><button onclick="openPillarModal()" class="text-xs bg-purple-100 text-purple-700 px-2 py-1 rounded flex items-center gap-1"><i data-lucide="plus" class="w-3 h-3"></i> Tambah</button></div><div id="pillar-container" class="grid grid-cols-1 gap-3"></div></div>
                    <div class="lg:w-2/3"><div class="flex justify-between items-center mb-3 border-b-2 border-[#A31ACB] pb-1"><h3 class="text-[#A31ACB] font-bold text-lg">Bentuk Kegiatan</h3><button onclick="openActivityModal()" class="text-xs bg-purple-100 text-purple-700 px-2 py-1 rounded flex items-center gap-1"><i data-lucide="plus" class="w-3 h-3"></i> Tambah</button></div><div class="overflow-x-auto"><table class="w-full text-sm text-left text-gray-600 border border-gray-200 rounded-lg overflow-hidden"><thead class="text-xs text-white uppercase bg-[#A31ACB]"><tr><th scope="col" class="px-4 py-3 w-10 text-center">No</th><th scope="col" class="px-4 py-3">Deskripsi Kegiatan</th><th scope="col" class="px-4 py-3 text-center w-20">Aksi</th></tr></thead><tbody id="activity-tbody" class="divide-y divide-gray-100"></tbody></table></div></div>
                </div>
                <div class="mt-8"><button onclick="navigateTo('page-home')" class="w-full bg-gray-100 hover:bg-gray-200 text-gray-700 font-semibold py-3 px-4 rounded-lg flex items-center justify-center gap-2"><i data-lucide="arrow-left" class="w-4 h-4"></i> Kembali ke Home</button></div>
            </div>
        </div>
    </section>

    <!-- Students Page -->
    <section id="page-students" class="hidden min-h-screen p-4 pb-10">
        <div class="max-w-md md:max-w-7xl mx-auto fade-in">
            <div class="bg-[#FF78F0] text-white p-6 rounded-t-2xl shadow-lg sticky top-0 z-10">
                <div class="flex flex-col md:flex-row md:items-center justify-between gap-4"><div><h2 class="font-bold text-lg">Daftar Murid</h2><p class="text-xs opacity-90">Kelola Murid Bimbingan</p></div><div class="flex items-center gap-2 self-end md:self-auto"><button onclick="openAddModal()" class="bg-white text-[#FF78F0] p-2 rounded-full shadow-sm"><i data-lucide="plus" class="w-5 h-5"></i></button><button onclick="navigateTo('page-home')" class="bg-white/20 p-2 rounded-full"><i data-lucide="home" class="w-5 h-5"></i></button></div></div>
                <div class="mt-4 pt-4 border-t border-white/20 flex flex-col md:flex-row gap-3 justify-between items-center">
                    <div class="flex gap-2 w-full md:w-auto">
                        <input type="file" id="importFile" accept=".xlsx, .xls" class="hidden" onchange="handleFileImport(this)">
                        <button onclick="exportToExcel()" class="flex-1 bg-white/20 hover:bg-white/30 text-white text-xs py-2 px-3 rounded-lg flex items-center justify-center gap-2"><i data-lucide="download" class="w-4 h-4"></i> Ekspor</button>
                        <button onclick="document.getElementById('importFile').click()" class="flex-1 bg-white/20 hover:bg-white/30 text-white text-xs py-2 px-3 rounded-lg flex items-center justify-center gap-2"><i data-lucide="upload" class="w-4 h-4"></i> Impor</button>
                        <!-- New Bulk Delete Button -->
                        <button onclick="openBulkDeleteModal()" class="flex-1 bg-white/20 hover:bg-red-500/80 text-white text-xs py-2 px-3 rounded-lg flex items-center justify-center gap-2 transition" title="Hapus Massal">
                            <i data-lucide="trash-2" class="w-4 h-4"></i> Hapus Massal
                        </button>
                    </div>
                    <div class="flex items-center gap-2 w-full md:w-auto justify-end"><label class="text-sm font-medium text-white/90">Filter Tahun:</label><select id="filterAcademicYear" onchange="renderStudents()" class="border-none rounded-lg p-2 text-sm text-[#FF78F0] bg-white cursor-pointer w-1/2 md:w-auto"><option value="all">Semua Tahun</option></select></div>
                </div>
            </div>
            <div class="bg-white p-6 rounded-b-2xl shadow-lg min-h-[400px]">
                <div id="student-list-container" class="space-y-4 md:space-y-0 md:grid md:grid-cols-2 lg:grid-cols-3 md:gap-4"></div>
                <div class="mt-8"><button onclick="navigateTo('page-home')" class="w-full bg-gray-100 hover:bg-gray-200 text-gray-700 font-semibold py-3 px-4 rounded-lg flex items-center justify-center gap-2"><i data-lucide="arrow-left" class="w-4 h-4"></i> Kembali ke Home</button></div>
            </div>
        </div>
    </section>

    <!-- Journal Page -->
    <section id="page-journal" class="hidden min-h-screen p-4 pb-10">
        <div class="max-w-md md:max-w-4xl mx-auto fade-in">
            <div class="bg-[#F5EA5A] text-gray-800 p-6 rounded-t-2xl shadow-lg flex items-center justify-between sticky top-0 z-10"><div><h2 class="font-bold text-lg">Jurnal Guru Wali</h2><p class="text-xs opacity-80">Formulir Catatan Bimbingan</p></div><button onclick="navigateTo('page-home')" class="bg-black/10 p-2 rounded-full"><i data-lucide="home" class="w-5 h-5"></i></button></div>
            <div class="bg-white p-6 rounded-b-2xl shadow-lg">
                <form id="journalForm" onsubmit="submitJournal(event)" class="space-y-4 md:space-y-0 md:grid md:grid-cols-2 md:gap-6">
                    <div><label class="block text-sm font-medium text-gray-700 mb-1">Tanggal</label><input type="date" name="tanggal" required class="w-full p-2 border border-gray-300 rounded-lg"></div>
                    <div><label class="block text-sm font-medium text-gray-700 mb-1">Waktu</label><input type="time" name="waktu" required class="w-full p-2 border border-gray-300 rounded-lg"></div>
                    <div class="md:col-span-2"><label class="block text-sm font-medium text-gray-700 mb-1">Nama Murid Bimbingan</label><input type="text" id="journalName" name="nama" list="dynamic_student_list" oninput="syncStudentData('journal')" placeholder="Ketik nama murid..." required class="w-full p-2 border border-gray-300 rounded-lg"><datalist id="dynamic_student_list"></datalist></div>
                    <div><label class="block text-sm font-medium text-gray-700 mb-1">Kelas</label><input type="text" id="journalClass" name="kelas" placeholder="Contoh: XII IPA 1" required class="w-full p-2 border border-gray-300 rounded-lg"></div>
                    <div><label class="block text-sm font-medium text-gray-700 mb-1">Tahun Ajaran</label><input type="text" id="journalAcademicYear" name="academicYear" placeholder="Contoh: 2024/2025" required class="w-full p-2 border border-gray-300 rounded-lg"></div>
                    <div class="md:col-span-2"><label class="block text-sm font-medium text-gray-700 mb-1">Jenis Bimbingan</label><select name="jenis" required class="w-full p-2 border border-gray-300 rounded-lg bg-white"><option value="" disabled selected>-- Pilih Jenis --</option><option value="Pendampingan Akademik">Pendampingan Akademik</option><option value="Pengembangan Kompetensi">Pengembangan Kompetensi</option><option value="Pengembangan Keterampilan">Pengembangan Keterampilan</option><option value="Pembentukan Karakter">Pembentukan Karakter</option></select></div>
                    <div class="md:col-span-2"><label class="block text-sm font-medium text-gray-700 mb-1">Topik / Permasalahan</label><textarea name="topik" rows="3" required placeholder="Deskripsikan..." class="w-full p-2 border border-gray-300 rounded-lg"></textarea></div>
                    <div class="md:col-span-2"><label class="block text-sm font-medium text-gray-700 mb-1">Tindak Lanjut</label><textarea name="tindak_lanjut" rows="3" required placeholder="Rencana..." class="w-full p-2 border border-gray-300 rounded-lg"></textarea></div>
                    <div class="md:col-span-2 pt-2"><button type="submit" id="btn-submit" class="w-full bg-[#F5EA5A] hover:bg-yellow-300 text-gray-900 font-bold py-3 px-4 rounded-lg shadow-md flex justify-center items-center gap-2"><i data-lucide="save" class="w-4 h-4"></i> Simpan Data</button></div>
                </form>
                <div class="mt-4"><button onclick="navigateTo('page-home')" class="w-full bg-gray-100 hover:bg-gray-200 text-gray-700 font-semibold py-3 px-4 rounded-lg flex items-center justify-center gap-2"><i data-lucide="arrow-left" class="w-4 h-4"></i> Kembali ke Home</button></div>
            </div>
        </div>
    </section>

    <!-- Recap Page -->
    <section id="page-recap" class="hidden min-h-screen p-4 pb-10">
        <div class="max-w-7xl mx-auto fade-in">
            <div class="bg-[#10B981] text-white p-6 rounded-t-2xl shadow-lg flex flex-col md:flex-row items-center justify-between gap-4 sticky top-0 z-10">
                <div><h2 class="font-bold text-lg">Rekap Jurnal</h2><p class="text-xs opacity-90">Riwayat Bimbingan Murid</p></div>
                <div class="flex gap-2 w-full md:w-auto overflow-x-auto pb-2 md:pb-0">
                    <button onclick="openPdfSettings()" class="bg-white/20 p-2 rounded-full w-8 h-8 flex items-center justify-center"><i data-lucide="settings" class="w-4 h-4"></i></button>
                    <button onclick="exportJournalToPdf()" class="bg-white/20 p-2 rounded-full flex items-center gap-1 px-3"><i data-lucide="file-text" class="w-4 h-4"></i> <span class="text-xs font-semibold">PDF</span></button>
                    <button onclick="exportJournalToExcel()" class="bg-white/20 p-2 rounded-full flex items-center gap-1 px-3"><i data-lucide="download" class="w-4 h-4"></i> <span class="text-xs font-semibold">Excel</span></button>
                    <button onclick="navigateTo('page-home')" class="bg-white/20 p-2 rounded-full w-8 h-8 flex items-center justify-center"><i data-lucide="home" class="w-4 h-4"></i></button>
                </div>
            </div>
            <div class="bg-white p-6 rounded-b-2xl shadow-lg overflow-x-auto min-h-[400px]">
                <table class="w-full text-sm text-left text-gray-600 border border-gray-200 rounded-lg">
                    <thead class="text-xs text-white uppercase bg-[#10B981]"><tr><th class="px-4 py-3 rounded-tl-lg">No</th><th class="px-4 py-3">Tanggal</th><th class="px-4 py-3">Nama Murid</th><th class="px-4 py-3 hidden md:table-cell">Kelas</th><th class="px-4 py-3 hidden md:table-cell">Thn Ajaran</th><th class="px-4 py-3">Jenis</th><th class="px-4 py-3 hidden md:table-cell">Topik</th><th class="px-4 py-3 hidden md:table-cell">Tindak</th><th class="px-4 py-3 rounded-tr-lg text-center w-24">Aksi</th></tr></thead>
                    <tbody id="journal-recap-body" class="divide-y divide-gray-100"></tbody>
                </table>
                <div id="empty-journal-msg" class="text-center py-8 text-gray-400 hidden">Belum ada data jurnal.</div>
                <div class="mt-8"><button onclick="navigateTo('page-home')" class="w-full bg-gray-100 hover:bg-gray-200 text-gray-700 font-semibold py-3 px-4 rounded-lg flex items-center justify-center gap-2"><i data-lucide="arrow-left" class="w-4 h-4"></i> Kembali ke Home</button></div>
            </div>
        </div>
    </section>

    <!-- Main Logic -->
    <script>
        // --- DATA ---
        const defaultStudents = [
            { name: "Salirah Aliska", nisn: "1234567890", class: "XII IPA 1", phone: "081234567891", address: "Jl. Mawar No. 1", academicYear: "2024/2025" },
            { name: "Sheina Najla Sabila", nisn: "2345678901", class: "XII IPA 2", phone: "081234567892", address: "Jl. Melati No. 5", academicYear: "2024/2025" },
            { name: "Dina Amalia", nisn: "3456789012", class: "XII IPA 1", phone: "081234567893", address: "Jl. Anggrek No. 10", academicYear: "2024/2025" },
            { name: "Desta Fiara Irawan", nisn: "4567890123", class: "XII IPS 1", phone: "081234567894", address: "Jl. Kenanga No. 3", academicYear: "2024/2025" },
            { name: "Pirman", nisn: "5678901234", class: "XII IPS 2", phone: "081234567895", address: "Jl. Kamboja No. 7", academicYear: "2024/2025" },
            { name: "Muhammad Dearya", nisn: "6789012345", class: "XII IPA 3", phone: "081234567896", address: "Jl. Tulip No. 9", academicYear: "2024/2025" },
            { name: "Hardiansyah Putra", nisn: "7890123456", class: "XII IPA 3", phone: "081234567897", address: "Jl. Dahlia No. 11", academicYear: "2024/2025" }
        ];
        const defaultPillars = [{name:"Pendampingan Akademik",icon:"book"},{name:"Pengembangan Kompetensi",icon:"award"},{name:"Pengembangan Keterampilan",icon:"pen-tool"},{name:"Pengembangan Karakter",icon:"heart"}];
        const defaultActivities = ["Melaksanakan diskusi rutin...","Memberikan saran...","Berkoordinasi dengan guru...","Memberikan informasi...","Mendorong murid...","Observasi perilaku...","Observasi kehadiran...","Sesi diskusi...","Penanganan awal..."];

        // PDF Settings (stored in local storage as preference is per device usually, but can be DB)
        let pdfSettings = JSON.parse(localStorage.getItem('guruWali_pdfSettings')) || { pageSize: 'a4', orientation: 'landscape', marginTop: 15, marginRight: 15, marginBottom: 15, marginLeft: 15 };

        // --- RENDER FUNCTIONS ---
        function renderStudents() {
            const container = document.getElementById('student-list-container');
            const filterValue = document.getElementById('filterAcademicYear').value;
            container.innerHTML = '';
            
            const filteredStudents = window.students.filter(s => filterValue === 'all' || (s.academicYear || "-") === filterValue);

            if (filteredStudents.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-400 py-4 col-span-full">Belum ada data murid.</p>';
                return;
            }

            filteredStudents.forEach((student, index) => {
                const el = document.createElement('div');
                el.className = 'bg-white border border-gray-100 rounded-lg p-4 shadow-sm hover:shadow-md transition duration-200 relative group';
                const imgSrc = student.photo ? student.photo : '';
                const imgDisplay = imgSrc ? `<img src="${imgSrc}" class="w-full h-full object-cover">` : `<div class="w-full h-full flex items-center justify-center bg-pink-100 text-[#FF78F0] font-bold text-lg">${index + 1}</div>`;

                el.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div class="flex items-start gap-3 w-full">
                            <div class="w-12 h-12 rounded-full bg-gray-100 flex-shrink-0 overflow-hidden border border-gray-100">${imgDisplay}</div>
                            <div class="flex-1 min-w-0">
                                <h4 class="font-bold text-gray-800 truncate">${student.name}</h4>
                                <div class="flex items-center gap-2 flex-wrap">
                                    <p class="text-xs text-[#FF78F0] font-semibold">${student.class}</p>
                                    <span class="text-[10px] bg-gray-100 text-gray-600 px-1.5 py-0.5 rounded border border-gray-200">NISN: ${student.nisn || "-"}</span>
                                </div>
                                <div class="mt-1 text-xs text-gray-500 space-y-0.5">
                                    <p class="flex items-center gap-1 truncate"><i class="w-3 h-3 flex-shrink-0" data-lucide="phone"></i> ${student.phone}</p>
                                    <p class="flex items-center gap-1 truncate"><i class="w-3 h-3 flex-shrink-0" data-lucide="map-pin"></i> ${student.address}</p>
                                    <p class="text-[10px] text-gray-400 mt-1">TA: ${student.academicYear || "-"}</p>
                                </div>
                            </div>
                        </div>
                        <div class="flex gap-1 flex-shrink-0 ml-2">
                            <button onclick="editStudent('${student.id}')" class="text-gray-400 hover:text-blue-500 transition p-1"><i data-lucide="pencil" class="w-4 h-4"></i></button>
                            <button onclick="deleteStudent('${student.id}')" class="text-gray-400 hover:text-red-500 transition p-1"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                        </div>
                    </div>`;
                container.appendChild(el);
            });
            lucide.createIcons();
        }

        function renderFilterOptions() {
            const filterSelect = document.getElementById('filterAcademicYear');
            const currentVal = filterSelect.value;
            const years = [...new Set(window.students.map(s => s.academicYear || "-"))].sort().reverse();
            filterSelect.innerHTML = '<option value="all">Semua Tahun</option>';
            years.forEach(year => {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year === "-" ? "Tanpa Tahun" : year;
                filterSelect.appendChild(option);
            });
            if ([...filterSelect.options].some(o => o.value === currentVal)) filterSelect.value = currentVal;
        }

        // --- NEW: Bulk Delete Modal Functions ---
        function openBulkDeleteModal() {
            // Get unique years
            const years = [...new Set(window.students.map(s => s.academicYear || "-"))].sort().reverse();
            // Get unique classes
            const classes = [...new Set(window.students.map(s => s.class || "-"))].sort();

            const yearSelect = document.getElementById('bulkDeleteYear');
            const classSelect = document.getElementById('bulkDeleteClass');

            yearSelect.innerHTML = '<option value="">-- Pilih Tahun Ajaran --</option>';
            years.forEach(y => {
                const opt = document.createElement('option');
                opt.value = y;
                opt.text = y === "-" ? "Tanpa Tahun" : y;
                yearSelect.appendChild(opt);
            });

            classSelect.innerHTML = '<option value="">-- Pilih Kelas --</option>';
            classes.forEach(c => {
                const opt = document.createElement('option');
                opt.value = c;
                opt.text = c === "-" ? "Tanpa Kelas" : c;
                classSelect.appendChild(opt);
            });

            document.getElementById('bulkDeleteModal').classList.remove('hidden');
        }

        function closeBulkDeleteModal() {
            document.getElementById('bulkDeleteModal').classList.add('hidden');
        }

        function confirmBulkDelete() {
            const year = document.getElementById('bulkDeleteYear').value;
            const className = document.getElementById('bulkDeleteClass').value;

            if (!year && !className) {
                Swal.fire('Error', 'Pilih minimal Tahun Ajaran atau Kelas.', 'error');
                return;
            }

            window.bulkDeleteStudentsDB(year, className);
        }

        function renderProgram() {
            const pillarContainer = document.getElementById('pillar-container');
            pillarContainer.innerHTML = '';
            window.pillars.forEach((pillar, index) => {
                const el = document.createElement('div');
                el.className = 'bg-purple-50 p-3 rounded-lg border-l-4 border-[#A31ACB] flex items-center justify-between group';
                el.innerHTML = `<div class="flex items-center gap-2"><i data-lucide="${pillar.icon}" class="w-4 h-4 text-[#A31ACB]"></i><span class="text-sm font-medium">${pillar.name}</span></div><div class="flex gap-1 opacity-0 group-hover:opacity-100 transition"><button onclick="editPillar(${index})" class="text-gray-400 hover:text-blue-500"><i data-lucide="pencil" class="w-3 h-3"></i></button><button onclick="deletePillar(${index})" class="text-gray-400 hover:text-red-500"><i data-lucide="trash-2" class="w-3 h-3"></i></button></div>`;
                pillarContainer.appendChild(el);
            });
            const activityTbody = document.getElementById('activity-tbody');
            activityTbody.innerHTML = '';
            window.activities.forEach((activity, index) => {
                const row = document.createElement('tr');
                row.className = index % 2 === 0 ? 'bg-white hover:bg-gray-50' : 'bg-purple-50 hover:bg-purple-100';
                row.innerHTML = `<td class="px-4 py-3 text-center font-bold text-[#A31ACB]">${index + 1}</td><td class="px-4 py-3">${activity}</td><td class="px-4 py-3 text-center"><div class="flex justify-center gap-2"><button onclick="editActivity(${index})" class="text-gray-400 hover:text-blue-500"><i data-lucide="pencil" class="w-3 h-3"></i></button><button onclick="deleteActivity(${index})" class="text-gray-400 hover:text-red-500"><i data-lucide="trash-2" class="w-3 h-3"></i></button></div></td>`;
                activityTbody.appendChild(row);
            });
            lucide.createIcons();
        }

        function renderJournalRecap() {
            const tbody = document.getElementById('journal-recap-body');
            const emptyMsg = document.getElementById('empty-journal-msg');
            tbody.innerHTML = '';
            if (window.journals.length === 0) { emptyMsg.classList.remove('hidden'); } 
            else {
                emptyMsg.classList.add('hidden');
                window.journals.forEach((j, index) => {
                    const row = document.createElement('tr');
                    row.className = "bg-white hover:bg-gray-50 border-b border-gray-100";
                    row.innerHTML = `<td class="px-4 py-3 font-bold text-emerald-600 text-center">${window.journals.length - index}</td><td class="px-4 py-3 whitespace-nowrap">${j.tanggal} <span class="text-xs text-gray-400 block">${j.waktu}</span></td><td class="px-4 py-3 font-medium text-gray-800">${j.nama}</td><td class="px-4 py-3 hidden md:table-cell">${j.kelas}</td><td class="px-4 py-3 text-xs text-gray-600 hidden md:table-cell">${j.academicYear || '-'}</td><td class="px-4 py-3"><span class="bg-emerald-100 text-emerald-800 text-xs px-2 py-1 rounded-full whitespace-nowrap">${j.jenis}</span></td><td class="px-4 py-3 max-w-xs truncate hidden md:table-cell" title="${j.topik}">${j.topik}</td><td class="px-4 py-3 max-w-xs truncate hidden md:table-cell" title="${j.tindak_lanjut}">${j.tindak_lanjut}</td><td class="px-4 py-3 text-center"><div class="flex items-center justify-center gap-2"><button onclick="editJournal('${j.id}')" class="text-gray-400 hover:text-blue-500 transition p-1"><i data-lucide="pencil" class="w-4 h-4"></i></button><button onclick="deleteJournal('${j.id}')" class="text-gray-400 hover:text-red-500 transition p-1"><i data-lucide="trash-2" class="w-4 h-4"></i></button></div></td>`;
                    tbody.appendChild(row);
                });
            }
            lucide.createIcons();
        }

        function renderJournalDatalist() {
            const listIds = ['dynamic_student_list', 'dynamic_student_list_modal'];
            listIds.forEach(id => {
                const datalist = document.getElementById(id);
                if (datalist) {
                    datalist.innerHTML = '';
                    window.students.forEach(student => {
                        const option = document.createElement('option');
                        option.value = student.name;
                        datalist.appendChild(option);
                    });
                }
            });
        }

        // --- CRUD LOGIC Handlers ---
        
        function openAddModal() {
            document.getElementById('studentId').value = ''; 
            document.getElementById('modal-title').innerText = 'Tambah Murid Baru';
            document.getElementById('studentName').value = '';
            document.getElementById('studentNisn').value = '';
            document.getElementById('studentClass').value = '';
            document.getElementById('studentPhone').value = '';
            document.getElementById('studentAddress').value = '';
            document.getElementById('studentAcademicYear').value = '2024/2025';
            document.getElementById('studentPhoto').value = '';
            document.getElementById('studentPhotoPreview').src = '';
            document.getElementById('studentPhotoPreview').classList.add('hidden');
            document.getElementById('studentPhotoPlaceholder').classList.remove('hidden');
            document.getElementById('studentModal').classList.remove('hidden');
        }
        function closeStudentModal() { document.getElementById('studentModal').classList.add('hidden'); }
        
        function editStudent(id) {
            const student = window.students.find(s => s.id === id);
            if (!student) return;
            document.getElementById('studentId').value = id;
            document.getElementById('modal-title').innerText = 'Edit Data Murid';
            document.getElementById('studentName').value = student.name;
            document.getElementById('studentNisn').value = student.nisn || "";
            document.getElementById('studentClass').value = student.class;
            document.getElementById('studentPhone').value = student.phone;
            document.getElementById('studentAddress').value = student.address;
            document.getElementById('studentAcademicYear').value = student.academicYear || "2024/2025";
            const preview = document.getElementById('studentPhotoPreview');
            const placeholder = document.getElementById('studentPhotoPlaceholder');
            if (student.photo) { preview.src = student.photo; preview.classList.remove('hidden'); placeholder.classList.add('hidden'); } 
            else { preview.src = ''; preview.classList.add('hidden'); placeholder.classList.remove('hidden'); }
            document.getElementById('studentPhoto').value = '';
            document.getElementById('studentModal').classList.remove('hidden');
        }

        async function saveStudent() {
            const id = document.getElementById('studentId').value;
            const name = document.getElementById('studentName').value;
            const nisn = document.getElementById('studentNisn').value;
            const className = document.getElementById('studentClass').value;
            const phone = document.getElementById('studentPhone').value;
            const address = document.getElementById('studentAddress').value;
            const academicYear = document.getElementById('studentAcademicYear').value;
            const photoInput = document.getElementById('studentPhoto');
            const btnSave = document.getElementById('btnSaveStudent');

            if (!name || !className) { Swal.fire('Oops...', 'Nama dan Kelas wajib diisi!', 'error'); return; }

            // Set loading state
            const originalText = btnSave.innerText;
            btnSave.disabled = true;
            btnSave.innerText = 'Menyimpan...';

            try {
                const finalizeSave = async (photoData) => {
                    const studentData = { name, nisn, class: className, phone, address, academicYear, photo: photoData };
                    await window.saveStudentDB(studentData, id || null);
                };

                if (photoInput.files && photoInput.files[0]) {
                    const reader = new FileReader();
                    reader.onload = async function(e) { await finalizeSave(e.target.result); };
                    reader.readAsDataURL(photoInput.files[0]);
                } else {
                    let existingPhoto = null;
                    if (id) { const s = window.students.find(s => s.id === id); if(s) existingPhoto = s.photo; }
                    await finalizeSave(existingPhoto);
                }
            } catch (error) {
                console.error("Save error:", error);
            } finally {
                // Restore button state
                btnSave.disabled = false;
                btnSave.innerText = originalText;
            }
        }

        function deleteStudent(id) {
            Swal.fire({ title: 'Hapus data?', icon: 'warning', showCancelButton: true, confirmButtonText: 'Ya, Hapus!', }).then((result) => {
                if (result.isConfirmed) { window.deleteStudentDB(id); }
            });
        }

        function previewImage(input) {
            const preview = document.getElementById('studentPhotoPreview');
            const placeholder = document.getElementById('studentPhotoPlaceholder');
            const file = input.files[0];
            if (file) {
                if (file.size > 500 * 1024) {
                    Swal.fire({ icon: 'error', title: 'File Terlalu Besar', text: 'Maksimal 500KB!', confirmButtonColor: '#FF78F0' });
                    input.value = ''; preview.src = ''; preview.classList.add('hidden'); placeholder.classList.remove('hidden');
                    return;
                }
                const reader = new FileReader();
                reader.onload = function(e) { preview.src = e.target.result; preview.classList.remove('hidden'); placeholder.classList.add('hidden'); }
                reader.readAsDataURL(file);
            }
        }

        // Program Logic
        function savePillar() {
            const index = parseInt(document.getElementById('pillarIndex').value);
            const name = document.getElementById('pillarName').value;
            const icon = document.getElementById('pillarIcon').value;
            if (!name) return;
            const data = { name, icon };
            if (index === -1) window.pillars.push(data); else window.pillars[index] = data;
            window.saveProgramDB('pillars', window.pillars);
            closePillarModal();
        }
        function deletePillar(index) {
            Swal.fire({ title: 'Hapus?', icon: 'warning', showCancelButton: true, confirmButtonText: 'Ya' }).then(res => {
                if(res.isConfirmed) { window.pillars.splice(index, 1); window.saveProgramDB('pillars', window.pillars); }
            });
        }
        // ... (Similar logic for activities)
        function saveActivity() {
            const index = parseInt(document.getElementById('activityIndex').value);
            const desc = document.getElementById('activityDesc').value;
            if(!desc) return;
            if(index === -1) window.activities.push(desc); else window.activities[index] = desc;
            window.saveProgramDB('activities', window.activities);
            closeActivityModal();
        }
        function deleteActivity(index) {
             Swal.fire({ title: 'Hapus?', icon: 'warning', showCancelButton: true, confirmButtonText: 'Ya' }).then(res => {
                if(res.isConfirmed) { window.activities.splice(index, 1); window.saveProgramDB('activities', window.activities); }
            });
        }

        // Journal Logic
        function submitJournal(e) {
            e.preventDefault();
            const form = document.getElementById('journalForm');
            const formData = new FormData(form);
            const data = Object.fromEntries(formData.entries());
            window.saveJournalDB(data);
            form.reset();
            setTimeout(() => navigateTo('page-recap'), 500);
        }
        function editJournal(id) {
            const journal = window.journals.find(j => j.id === id);
            if (!journal) return;
            document.getElementById('editJournalId').value = id;
            document.getElementById('editJournalDate').value = journal.tanggal;
            document.getElementById('editJournalTime').value = journal.waktu;
            document.getElementById('editJournalName').value = journal.nama;
            document.getElementById('editJournalClass').value = journal.kelas;
            document.getElementById('editJournalAcademicYear').value = journal.academicYear || "";
            document.getElementById('editJournalType').value = journal.jenis;
            document.getElementById('editJournalTopic').value = journal.topik;
            document.getElementById('editJournalAction').value = journal.tindak_lanjut;
            document.getElementById('journalModal').classList.remove('hidden');
        }
        function closeJournalModal() { document.getElementById('journalModal').classList.add('hidden'); }
        function saveJournalEdit() {
            const id = document.getElementById('editJournalId').value;
            const updatedJournal = {
                tanggal: document.getElementById('editJournalDate').value,
                waktu: document.getElementById('editJournalTime').value,
                nama: document.getElementById('editJournalName').value,
                kelas: document.getElementById('editJournalClass').value,
                academicYear: document.getElementById('editJournalAcademicYear').value,
                jenis: document.getElementById('editJournalType').value,
                topik: document.getElementById('editJournalTopic').value,
                tindak_lanjut: document.getElementById('editJournalAction').value
            };
            window.saveJournalDB(updatedJournal, id);
        }
        function deleteJournal(id) {
            Swal.fire({ title: 'Hapus?', icon: 'warning', showCancelButton: true, confirmButtonColor: '#d33', confirmButtonText: 'Ya' }).then((result) => {
                if (result.isConfirmed) { window.deleteJournalDB(id); }
            });
        }

        // --- Helpers ---
        function syncStudentData(prefix) {
            const nameInput = document.getElementById(prefix + 'Name');
            const classInput = document.getElementById(prefix + 'Class');
            const academicYearInput = document.getElementById(prefix + 'AcademicYear');
            const student = window.students.find(s => s.name === nameInput.value);
            if (student) {
                classInput.value = student.class; classInput.classList.add('bg-yellow-50');
                if (academicYearInput) { academicYearInput.value = student.academicYear || ""; academicYearInput.classList.add('bg-yellow-50'); }
                setTimeout(() => { classInput.classList.remove('bg-yellow-50'); if(academicYearInput) academicYearInput.classList.remove('bg-yellow-50'); }, 500);
            }
        }

        function exportToExcel() {
            const excelData = window.students.map((s, index) => ({ "No": index + 1, "NISN": s.nisn || "-", "Nama": s.name, "Kelas": s.class, "HP": s.phone, "Alamat": s.address, "Tahun Ajaran": s.academicYear || "-" }));
            const worksheet = XLSX.utils.json_to_sheet(excelData);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, "Daftar Murid");
            XLSX.writeFile(workbook, `Data_Murid_${new Date().toISOString().slice(0, 10)}.xlsx`);
        }

        function exportJournalToExcel() {
            if (window.journals.length === 0) { Swal.fire('Info', 'Belum ada data.', 'info'); return; }
            const excelData = window.journals.map((j, index) => ({ "No": index + 1, "Tanggal": j.tanggal, "Waktu": j.waktu, "Nama Siswa": j.nama, "Kelas": j.kelas, "Tahun Ajaran": j.academicYear, "Jenis Bimbingan": j.jenis, "Topik": j.topik, "Tindak Lanjut": j.tindak_lanjut }));
            const worksheet = XLSX.utils.json_to_sheet(excelData);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, "Rekap Jurnal");
            XLSX.writeFile(workbook, `Rekap_Jurnal_${new Date().toISOString().slice(0, 10)}.xlsx`);
        }

        async function handleFileImport(input) {
            const file = input.files[0];
            if (!file) return;
            
            // Show loading
            Swal.fire({
                title: 'Memproses Data...',
                text: 'Mohon tunggu sebentar.',
                allowOutsideClick: false,
                didOpen: () => { Swal.showLoading() }
            });

            const reader = new FileReader();
            reader.onload = async function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    const jsonData = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
                    
                    if (jsonData.length === 0) { 
                        Swal.fire('Gagal', 'File kosong.', 'error'); 
                        input.value = '';
                        return; 
                    }

                    const result = await Swal.fire({
                        title: 'Impor Data?', 
                        text: `Ditemukan ${jsonData.length} data. Tambahkan ke database?`, 
                        icon: 'question', 
                        showCancelButton: true, 
                        confirmButtonText: 'Ya, Tambahkan'
                    });

                    if (result.isConfirmed) {
                        // Show processing alert
                        Swal.fire({
                            title: 'Sedang Mengunggah...',
                            html: 'Mohon jangan tutup halaman ini.',
                            allowOutsideClick: false,
                            didOpen: () => { Swal.showLoading() }
                        });

                        let successCount = 0;
                        for (const row of jsonData) {
                            // Flexible key mapping helper
                            const getVal = (keys) => {
                                for (let k of keys) if (row[k] !== undefined) return row[k];
                                const rowKeys = Object.keys(row);
                                for (let k of keys) {
                                    const found = rowKeys.find(rk => rk.toLowerCase() === k.toLowerCase());
                                    if (found) return row[found];
                                }
                                return null;
                            };

                            const newStudent = {
                                name: getVal(['Nama', 'Nama Lengkap', 'Nama Siswa', 'Student Name']) || "Tanpa Nama",
                                nisn: getVal(['NISN', 'Nomor Induk']) || "-",
                                class: getVal(['Kelas', 'Class', 'Rombel']) || "-",
                                phone: getVal(['HP', 'No HP', 'No. HP', 'Nomor HP', 'WhatsApp', 'WA']) || "-",
                                address: getVal(['Alamat', 'Address']) || "-",
                                academicYear: getVal(['Tahun', 'Tahun Ajaran', 'Academic Year', 'TA']) || "2024/2025"
                            };
                            
                            // Basic validation
                            if (newStudent.name && newStudent.name !== "Tanpa Nama") {
                                await window.saveStudentDB(newStudent, null, true); // silent = true
                                successCount++;
                            }
                        }
                        Swal.fire('Selesai', `${successCount} data berhasil ditambahkan.`, 'success');
                    }
                } catch (error) { 
                    console.error(error);
                    Swal.fire('Error', 'Gagal membaca file. Pastikan format Excel benar.', 'error'); 
                }
                input.value = '';
            };
            reader.readAsArrayBuffer(file);
        }

        // Modal Helpers (duplicated for clarity if needed, or reused from above)
        function openPillarModal() { document.getElementById('pillarIndex').value = '-1'; document.getElementById('pillarName').value = ''; document.getElementById('pillarModal').classList.remove('hidden'); }
        function closePillarModal() { document.getElementById('pillarModal').classList.add('hidden'); }
        function editPillar(index) { document.getElementById('pillarIndex').value = index; document.getElementById('pillarName').value = window.pillars[index].name; document.getElementById('pillarIcon').value = window.pillars[index].icon; document.getElementById('pillarModal').classList.remove('hidden'); }
        
        function openActivityModal() { document.getElementById('activityIndex').value = '-1'; document.getElementById('activityDesc').value = ''; document.getElementById('activityModal').classList.remove('hidden'); }
        function closeActivityModal() { document.getElementById('activityModal').classList.add('hidden'); }
        function editActivity(index) { document.getElementById('activityIndex').value = index; document.getElementById('activityDesc').value = window.activities[index]; document.getElementById('activityModal').classList.remove('hidden'); }

        function navigateTo(pageId) {
            document.querySelectorAll('section').forEach(p => { p.classList.add('hidden'); p.querySelector('.fade-in')?.classList.remove('fade-in'); });
            const selected = document.getElementById(pageId);
            selected.classList.remove('hidden');
            setTimeout(() => selected.querySelector('div').classList.add('fade-in'), 10);
            window.scrollTo(0,0);
        }

        function showToast(title, message, type) {
            const toast = document.getElementById('toast');
            const container = toast.querySelector('div');
            document.getElementById('toast-title').textContent = title;
            document.getElementById('toast-message').textContent = message;
            container.className = type === 'success' ? "bg-white border-l-4 border-green-500 shadow-lg rounded-lg p-4 w-72 flex items-center gap-3" : "bg-white border-l-4 border-red-500 shadow-lg rounded-lg p-4 w-72 flex items-center gap-3";
            document.getElementById('toast-icon').innerHTML = type === 'success' ? `<i data-lucide="check-circle" class="w-6 h-6 text-green-500"></i>` : `<i data-lucide="alert-circle" class="w-6 h-6 text-red-500"></i>`;
            lucide.createIcons();
            toast.classList.remove('translate-x-full', 'opacity-0');
            setTimeout(() => toast.classList.add('translate-x-full', 'opacity-0'), 3000);
        }

        // PDF Logic (Keep existing)
        function openPdfSettings() { document.getElementById('pdfSettingsModal').classList.remove('hidden'); }
        function closePdfSettings() { 
            pdfSettings.pageSize = document.getElementById('pdfSize').value;
            pdfSettings.orientation = document.querySelector('input[name="pdfOrientation"]:checked').value;
            pdfSettings.marginTop = Number(document.getElementById('pdfMarginTop').value);
            pdfSettings.marginRight = Number(document.getElementById('pdfMarginRight').value);
            pdfSettings.marginBottom = Number(document.getElementById('pdfMarginBottom').value);
            pdfSettings.marginLeft = Number(document.getElementById('pdfMarginLeft').value);
            localStorage.setItem('guruWali_pdfSettings', JSON.stringify(pdfSettings));
            document.getElementById('pdfSettingsModal').classList.add('hidden');
        }
        function exportJournalToPdf() {
            if (window.journals.length === 0) { Swal.fire('Info', 'Belum ada data jurnal.', 'info'); return; }
            const { jsPDF } = window.jspdf;
            let format = pdfSettings.pageSize === 'f4' ? [215, 330] : pdfSettings.pageSize;
            const doc = new jsPDF({ orientation: pdfSettings.orientation, unit: 'mm', format: format });
            doc.setFontSize(16); doc.text("Rekap Jurnal Guru Wali", pdfSettings.marginLeft, pdfSettings.marginTop);
            doc.setFontSize(12); doc.text("Dwik Setyawan, S.Pd.", pdfSettings.marginLeft, pdfSettings.marginTop + 7);
            const headers = [['No', 'Tanggal', 'Waktu', 'Nama Murid', 'Kelas', 'Thn Ajaran', 'Jenis', 'Topik', 'Tindak Lanjut']];
            const data = window.journals.map((j, index) => [index + 1, j.tanggal, j.waktu, j.nama, j.kelas, j.academicYear || '-', j.jenis, j.topik, j.tindak_lanjut]);
            doc.autoTable({ head: headers, body: data, startY: pdfSettings.marginTop + 15, margin: { top: pdfSettings.marginTop, right: pdfSettings.marginRight, bottom: pdfSettings.marginBottom, left: pdfSettings.marginLeft }, styles: { fontSize: 8, cellPadding: 2 }, headStyles: { fillColor: [16, 185, 129] }, theme: 'grid' });
            doc.save(`Jurnal_Wali_${new Date().toISOString().slice(0,10)}.pdf`);
        }

        lucide.createIcons();
    </script>
</body>
</html><!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aplikasi Guru Wali - Dwik Setyawan, S.Pd.</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <!-- SheetJS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- jsPDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>
    
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot, query, orderBy, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase Configuration (Environment Variables)
        const firebaseConfig = JSON.parse(__firebase_config);
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        let currentUser = null;

        // Global State Arrays
        window.students = [];
        window.journals = [];
        window.pillars = [];
        window.activities = [];
        
        // Initialize Auth & Database Listeners
        const initAuth = async () => {
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                await signInWithCustomToken(auth, __initial_auth_token);
            } else {
                await signInAnonymously(auth);
            }
        };

        initAuth();

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                console.log("Database Connected as:", user.uid);
                setupListeners(user.uid);
            }
        });

        // Setup Real-time Listeners
        function setupListeners(userId) {
            // 1. Listen for Students
            const studentRef = collection(db, 'artifacts', appId, 'users', userId, 'students');
            onSnapshot(studentRef, (snapshot) => {
                window.students = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                // Jika kosong, isi data default sekali saja
                if (window.students.length === 0 && !localStorage.getItem('dataSeeded')) {
                    seedDefaultData(userId);
                }
                renderFilterOptions();
                renderStudents();
                renderJournalDatalist();
            }, (error) => console.error("Student sync error:", error));

            // 2. Listen for Journals
            const journalRef = collection(db, 'artifacts', appId, 'users', userId, 'journals');
            onSnapshot(journalRef, (snapshot) => {
                // Sort manual karena Firestore complex query butuh index
                window.journals = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }))
                                               .sort((a, b) => new Date(b.tanggal + ' ' + b.waktu) - new Date(a.tanggal + ' ' + a.waktu));
                renderJournalRecap();
            }, (error) => console.error("Journal sync error:", error));

            // 3. Listen for Program (Pillars & Activities stored in a settings collection)
            const settingsRef = collection(db, 'artifacts', appId, 'users', userId, 'settings');
            onSnapshot(settingsRef, (snapshot) => {
                const settings = snapshot.docs.reduce((acc, doc) => ({...acc, [doc.id]: doc.data()}), {});
                
                if (settings.program) {
                    window.pillars = settings.program.pillars || [];
                    window.activities = settings.program.activities || [];
                } else {
                    // Load defaults locally if not in DB yet
                    window.pillars = defaultPillars;
                    window.activities = defaultActivities;
                }
                renderProgram();
            }, (error) => console.error("Settings sync error:", error));
        }

        // Helper to seed initial data
        async function seedDefaultData(userId) {
            const batch = writeBatch(db);
            const studentCol = collection(db, 'artifacts', appId, 'users', userId, 'students');
            
            defaultStudents.forEach(s => {
                const docRef = doc(studentCol);
                batch.set(docRef, s);
            });

            // Save default program settings
            const settingsDoc = doc(db, 'artifacts', appId, 'users', userId, 'settings', 'program');
            batch.set(settingsDoc, { pillars: defaultPillars, activities: defaultActivities });

            await batch.commit();
            localStorage.setItem('dataSeeded', 'true');
            console.log("Default data seeded to database.");
        }

        // --- EXPORTED FUNCTIONS FOR HTML ONCLICK ---
        
        // Students CRUD
        window.saveStudentDB = async (studentData, id = null, silent = false) => {
            if (!currentUser) return;
            const col = collection(db, 'artifacts', appId, 'users', currentUser.uid, 'students');
            try {
                if (id) {
                    await updateDoc(doc(col, id), studentData);
                    if (!silent) showToast('Berhasil', 'Data murid diperbarui di database.', 'success');
                } else {
                    await addDoc(col, studentData);
                    if (!silent) showToast('Berhasil', 'Data murid disimpan ke database.', 'success');
                }
                if (!silent) closeStudentModal();
            } catch (e) {
                console.error(e);
                if (!silent) showToast('Gagal', 'Terjadi kesalahan database.', 'error');
                throw e; 
            }
        };

        window.deleteStudentDB = async (id) => {
            if (!currentUser) return;
            try {
                await deleteDoc(doc(db, 'artifacts', appId, 'users', currentUser.uid, 'students', id));
                showToast('Terhapus', 'Data murid dihapus dari database.', 'success');
            } catch (e) {
                showToast('Gagal', 'Gagal menghapus data.', 'error');
            }
        };

        // NEW: Bulk Delete Function
        window.bulkDeleteStudentsDB = async (year, className) => {
            if (!currentUser) return;
            
            // Filter locally first to get IDs
            const studentsToDelete = window.students.filter(s => {
                const matchYear = year ? (s.academicYear === year) : true;
                const matchClass = className ? (s.class === className) : true;
                return matchYear && matchClass;
            });

            if (studentsToDelete.length === 0) {
                Swal.fire('Info', 'Tidak ada data murid yang sesuai kriteria.', 'info');
                return;
            }

            // Confirm again before deleting
            const result = await Swal.fire({
                title: 'Konfirmasi Hapus Massal',
                text: `Akan menghapus ${studentsToDelete.length} murid (Tahun: ${year || 'Semua'}, Kelas: ${className || 'Semua'}). Lanjutkan?`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'Ya, Hapus Semua!'
            });

            if (result.isConfirmed) {
                const batch = writeBatch(db);
                studentsToDelete.forEach(s => {
                    const docRef = doc(db, 'artifacts', appId, 'users', currentUser.uid, 'students', s.id);
                    batch.delete(docRef);
                });

                try {
                    await batch.commit();
                    showToast('Berhasil', `${studentsToDelete.length} data murid berhasil dihapus.`, 'success');
                    closeBulkDeleteModal();
                } catch (e) {
                    console.error(e);
                    showToast('Gagal', 'Gagal melakukan penghapusan massal.', 'error');
                }
            }
        };

        // Journals CRUD
        window.saveJournalDB = async (journalData, id = null) => {
            if (!currentUser) return;
            const col = collection(db, 'artifacts', appId, 'users', currentUser.uid, 'journals');
            try {
                if (id) {
                    await updateDoc(doc(col, id), journalData);
                    showToast('Berhasil', 'Jurnal diperbarui.', 'success');
                } else {
                    await addDoc(col, journalData);
                    showToast('Berhasil', 'Jurnal tersimpan.', 'success');
                }
                if(id) closeJournalModal(); 
            } catch (e) {
                console.error(e);
                showToast('Gagal', 'Gagal menyimpan jurnal.', 'error');
            }
        };

        window.deleteJournalDB = async (id) => {
            if (!currentUser) return;
            try {
                await deleteDoc(doc(db, 'artifacts', appId, 'users', currentUser.uid, 'journals', id));
                showToast('Terhapus', 'Jurnal dihapus.', 'success');
            } catch (e) {
                showToast('Gagal', 'Gagal menghapus jurnal.', 'error');
            }
        };

        // Program CRUD (Single Doc Update)
        window.saveProgramDB = async (type, dataArray) => {
            if (!currentUser) return;
            const docRef = doc(db, 'artifacts', appId, 'users', currentUser.uid, 'settings', 'program');
            try {
                // We need to merge with existing data, or set if new
                // Simplified: we just update the specific field
                await updateDoc(docRef, { [type]: dataArray }).catch(async () => {
                    // If doc doesn't exist, set it (fallback)
                    await setDoc(docRef, { pillars: window.pillars, activities: window.activities });
                });
                showToast('Berhasil', 'Program diperbarui.', 'success');
            } catch (e) {
                console.error(e);
            }
        };

    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Poppins', sans-serif; }
        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen relative overflow-x-hidden">

    <!-- Notification Toast -->
    <div id="toast" class="fixed top-5 right-5 z-[80] transform transition-all duration-300 translate-x-full opacity-0">
        <div class="bg-white border-l-4 shadow-lg rounded-lg p-4 w-72 flex items-center gap-3">
            <div id="toast-icon"></div>
            <div>
                <h4 id="toast-title" class="font-bold text-sm"></h4>
                <p id="toast-message" class="text-xs text-gray-600"></p>
            </div>
        </div>
    </div>

    <!-- Bulk Delete Modal (NEW) -->
    <div id="bulkDeleteModal" class="fixed inset-0 z-[70] hidden overflow-y-auto">
        <div class="flex items-center justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
            <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" onclick="closeBulkDeleteModal()"></div>
            <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-sm w-full">
                <div class="bg-white px-4 pt-5 pb-4 sm:p-6">
                    <div class="flex items-center gap-3 mb-4 border-b pb-2">
                        <div class="bg-red-100 p-2 rounded-full"><i data-lucide="trash-2" class="w-5 h-5 text-red-600"></i></div>
                        <h3 class="text-lg font-bold text-gray-900">Hapus Massal Murid</h3>
                    </div>
                    <p class="text-sm text-gray-500 mb-4">Pilih kriteria murid yang ingin dihapus. Tindakan ini tidak dapat dibatalkan.</p>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Tahun Ajaran</label>
                            <select id="bulkDeleteYear" class="w-full border border-gray-300 rounded-md p-2 text-sm bg-white">
                                <!-- Populated by JS -->
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Kelas</label>
                            <select id="bulkDeleteClass" class="w-full border border-gray-300 rounded-md p-2 text-sm bg-white">
                                <!-- Populated by JS -->
                            </select>
                        </div>
                    </div>
                </div>
                <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse gap-2">
                    <button onclick="confirmBulkDelete()" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-red-600 text-base font-medium text-white hover:bg-red-700 sm:w-auto sm:text-sm">Hapus Data</button>
                    <button onclick="closeBulkDeleteModal()" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 sm:mt-0 sm:w-auto sm:text-sm">Batal</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Student Modal -->
    <div id="studentModal" class="fixed inset-0 z-[60] hidden overflow-y-auto">
        <div class="flex items-center justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
            <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" onclick="closeStudentModal()"></div>
            <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg w-full">
                <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                    <div class="sm:flex sm:items-start">
                        <div class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-pink-100 sm:mx-0 sm:h-10 sm:w-10">
                            <i data-lucide="user-plus" class="h-6 w-6 text-pink-600"></i>
                        </div>
                        <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left w-full">
                            <h3 class="text-lg leading-6 font-medium text-gray-900" id="modal-title">Form Data Murid</h3>
                            <div class="mt-4 space-y-3">
                                <input type="hidden" id="studentId"> <!-- Changed from index to ID -->
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Foto Murid</label>
                                    <div class="flex items-center gap-4">
                                        <div class="w-16 h-16 rounded-full overflow-hidden bg-gray-100 border border-gray-200 flex-shrink-0 relative">
                                            <img id="studentPhotoPreview" src="" class="w-full h-full object-cover hidden">
                                            <div id="studentPhotoPlaceholder" class="w-full h-full flex items-center justify-center text-gray-400">
                                                <i data-lucide="camera" class="w-6 h-6"></i>
                                            </div>
                                        </div>
                                        <input type="file" id="studentPhoto" accept="image/*" onchange="previewImage(this)" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-xs file:font-semibold file:bg-pink-50 file:text-pink-700 hover:file:bg-pink-100 cursor-pointer">
                                    </div>
                                    <p class="text-[10px] text-gray-500 mt-1">*Format: JPG/PNG, Maksimal ukuran: 500KB</p>
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Tahun Ajaran</label>
                                    <input type="text" id="studentAcademicYear" list="academicYearOptions" placeholder="Contoh: 2024/2025" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-pink-500 focus:border-pink-500">
                                    <datalist id="academicYearOptions">
                                        <option value="2023/2024">
                                        <option value="2024/2025">
                                        <option value="2025/2026">
                                    </datalist>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">NISN</label>
                                    <input type="number" id="studentNisn" placeholder="Nomor Induk Siswa Nasional" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-pink-500 focus:border-pink-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Nama Lengkap</label>
                                    <input type="text" id="studentName" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-pink-500 focus:border-pink-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Kelas</label>
                                    <input type="text" id="studentClass" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-pink-500 focus:border-pink-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">No. HP / WA</label>
                                    <input type="text" id="studentPhone" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-pink-500 focus:border-pink-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Alamat</label>
                                    <textarea id="studentAddress" rows="2" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-pink-500 focus:border-pink-500"></textarea>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                    <button type="button" id="btnSaveStudent" onclick="saveStudent()" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-[#FF78F0] text-base font-medium text-white hover:bg-pink-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-pink-500 sm:ml-3 sm:w-auto sm:text-sm">Simpan</button>
                    <button type="button" onclick="closeStudentModal()" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">Batal</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Journal Edit Modal -->
    <div id="journalModal" class="fixed inset-0 z-[60] hidden overflow-y-auto">
        <div class="flex items-center justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
            <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" onclick="closeJournalModal()"></div>
            <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-2xl w-full">
                <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                    <div class="sm:flex sm:items-start">
                        <div class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-emerald-100 sm:mx-0 sm:h-10 sm:w-10">
                            <i data-lucide="edit-3" class="h-6 w-6 text-emerald-600"></i>
                        </div>
                        <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left w-full">
                            <h3 class="text-lg leading-6 font-medium text-gray-900" id="journal-modal-title">Edit Data Jurnal</h3>
                            <div class="mt-4 space-y-3 md:grid md:grid-cols-2 md:gap-4 md:space-y-0">
                                <input type="hidden" id="editJournalId"> <!-- Changed to ID -->
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Tanggal</label>
                                    <input type="date" id="editJournalDate" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-emerald-500 focus:border-emerald-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Waktu</label>
                                    <input type="time" id="editJournalTime" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-emerald-500 focus:border-emerald-500">
                                </div>
                                <div class="md:col-span-2">
                                    <label class="block text-sm font-medium text-gray-700">Nama Murid</label>
                                    <input type="text" id="editJournalName" list="dynamic_student_list_modal" oninput="syncStudentData('editJournal')" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-emerald-500 focus:border-emerald-500">
                                    <datalist id="dynamic_student_list_modal"></datalist>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Kelas</label>
                                    <input type="text" id="editJournalClass" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-emerald-500 focus:border-emerald-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Tahun Ajaran</label>
                                    <input type="text" id="editJournalAcademicYear" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-emerald-500 focus:border-emerald-500">
                                </div>
                                <div class="md:col-span-2">
                                    <label class="block text-sm font-medium text-gray-700">Jenis Bimbingan</label>
                                    <select id="editJournalType" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-emerald-500 focus:border-emerald-500 bg-white">
                                        <option value="Pendampingan Akademik">Pendampingan Akademik</option>
                                        <option value="Pengembangan Kompetensi">Pengembangan Kompetensi</option>
                                        <option value="Pengembangan Keterampilan">Pengembangan Keterampilan</option>
                                        <option value="Pembentukan Karakter">Pembentukan Karakter</option>
                                    </select>
                                </div>
                                <div class="md:col-span-2">
                                    <label class="block text-sm font-medium text-gray-700">Topik</label>
                                    <textarea id="editJournalTopic" rows="2" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-emerald-500 focus:border-emerald-500"></textarea>
                                </div>
                                <div class="md:col-span-2">
                                    <label class="block text-sm font-medium text-gray-700">Tindak Lanjut</label>
                                    <textarea id="editJournalAction" rows="2" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-emerald-500 focus:border-emerald-500"></textarea>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                    <button onclick="saveJournalEdit()" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-[#10B981] text-base font-medium text-white hover:bg-emerald-600 sm:ml-3 sm:w-auto sm:text-sm">Update</button>
                    <button onclick="closeJournalModal()" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">Batal</button>
                </div>
            </div>
        </div>
    </div>

    <!-- PDF Settings Modal -->
    <div id="pdfSettingsModal" class="fixed inset-0 z-[70] hidden overflow-y-auto">
        <div class="flex items-center justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
            <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" onclick="closePdfSettings()"></div>
            <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-sm w-full">
                <div class="bg-white px-4 pt-5 pb-4 sm:p-6">
                    <h3 class="text-lg font-bold text-gray-900 mb-4">Pengaturan PDF</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-xs font-semibold text-gray-600 uppercase mb-1">Ukuran Kertas</label>
                            <select id="pdfSize" class="w-full border border-gray-300 rounded p-2 text-sm bg-white">
                                <option value="a4">A4 (210 x 297 mm)</option>
                                <option value="f4">F4 / Folio (215 x 330 mm)</option>
                                <option value="legal">Legal (216 x 356 mm)</option>
                                <option value="letter">Letter (216 x 279 mm)</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs font-semibold text-gray-600 uppercase mb-1">Orientasi</label>
                            <div class="flex gap-2">
                                <label class="flex-1 cursor-pointer">
                                    <input type="radio" name="pdfOrientation" value="portrait" class="peer hidden">
                                    <div class="border border-gray-300 rounded p-2 text-center text-sm peer-checked:bg-emerald-100 peer-checked:border-emerald-500 peer-checked:text-emerald-700 hover:bg-gray-50 transition">Potret</div>
                                </label>
                                <label class="flex-1 cursor-pointer">
                                    <input type="radio" name="pdfOrientation" value="landscape" class="peer hidden" checked>
                                    <div class="border border-gray-300 rounded p-2 text-center text-sm peer-checked:bg-emerald-100 peer-checked:border-emerald-500 peer-checked:text-emerald-700 hover:bg-gray-50 transition">Lanskap</div>
                                </label>
                            </div>
                        </div>
                        <div>
                            <label class="block text-xs font-semibold text-gray-600 uppercase mb-1">Margin (mm)</label>
                            <div class="grid grid-cols-2 gap-2">
                                <div><span class="text-[10px] text-gray-400">Atas</span><input type="number" id="pdfMarginTop" value="15" class="w-full border p-1 rounded text-sm"></div>
                                <div><span class="text-[10px] text-gray-400">Kanan</span><input type="number" id="pdfMarginRight" value="15" class="w-full border p-1 rounded text-sm"></div>
                                <div><span class="text-[10px] text-gray-400">Bawah</span><input type="number" id="pdfMarginBottom" value="15" class="w-full border p-1 rounded text-sm"></div>
                                <div><span class="text-[10px] text-gray-400">Kiri</span><input type="number" id="pdfMarginLeft" value="15" class="w-full border p-1 rounded text-sm"></div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="bg-gray-50 px-4 py-3 sm:px-6 flex justify-end">
                    <button onclick="closePdfSettings()" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-[#10B981] text-base font-medium text-white hover:bg-emerald-600 sm:text-sm">Simpan Pengaturan</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Pillar & Activity Modals -->
    <div id="pillarModal" class="fixed inset-0 z-[60] hidden overflow-y-auto">
        <!-- Content same as previous, logic handled by openPillarModal -->
        <div class="flex items-center justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
            <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" onclick="closePillarModal()"></div>
            <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-md w-full">
                <div class="bg-white px-4 pt-5 pb-4 sm:p-6">
                    <h3 id="pillarModalTitle" class="text-lg font-medium text-gray-900 mb-4">Edit Pilar</h3>
                    <input type="hidden" id="pillarIndex">
                    <div class="space-y-3">
                        <div><label class="block text-sm font-medium text-gray-700">Nama Pilar</label><input type="text" id="pillarName" class="mt-1 block w-full border border-gray-300 rounded-md p-2"></div>
                        <div><label class="block text-sm font-medium text-gray-700">Ikon</label><select id="pillarIcon" class="mt-1 block w-full border border-gray-300 rounded-md p-2 bg-white"><option value="book">Book</option><option value="award">Award</option><option value="pen-tool">Pen Tool</option><option value="heart">Heart</option><option value="star">Star</option><option value="users">Users</option><option value="lightbulb">Lightbulb</option><option value="target">Target</option></select></div>
                    </div>
                </div>
                <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                    <button onclick="savePillar()" class="w-full inline-flex justify-center rounded-md bg-[#A31ACB] px-4 py-2 text-white hover:bg-purple-600 sm:ml-3 sm:w-auto sm:text-sm">Simpan</button>
                    <button onclick="closePillarModal()" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 px-4 py-2 bg-white hover:bg-gray-50 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">Batal</button>
                </div>
            </div>
        </div>
    </div>

    <div id="activityModal" class="fixed inset-0 z-[60] hidden overflow-y-auto">
        <div class="flex items-center justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
            <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" onclick="closeActivityModal()"></div>
            <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-md w-full">
                <div class="bg-white px-4 pt-5 pb-4 sm:p-6">
                    <h3 id="activityModalTitle" class="text-lg font-medium text-gray-900 mb-4">Edit Kegiatan</h3>
                    <input type="hidden" id="activityIndex">
                    <div><label class="block text-sm font-medium text-gray-700">Deskripsi Kegiatan</label><textarea id="activityDesc" rows="4" class="mt-1 block w-full border border-gray-300 rounded-md p-2"></textarea></div>
                </div>
                <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                    <button onclick="saveActivity()" class="w-full inline-flex justify-center rounded-md bg-[#A31ACB] px-4 py-2 text-white hover:bg-purple-600 sm:ml-3 sm:w-auto sm:text-sm">Simpan</button>
                    <button onclick="closeActivityModal()" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 px-4 py-2 bg-white hover:bg-gray-50 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">Batal</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Landing Page -->
    <section id="page-landing" class="flex items-center justify-center min-h-screen p-4">
        <div class="w-full max-w-md bg-[#39B5E0] rounded-2xl shadow-2xl p-8 text-center text-white fade-in relative overflow-hidden">
            <div class="absolute -top-10 -right-10 w-32 h-32 bg-white opacity-10 rounded-full"></div>
            <div class="mb-6 flex justify-center"><div class="bg-white p-4 rounded-full shadow-md text-[#39B5E0]"><i data-lucide="graduation-cap" class="w-12 h-12"></i></div></div>
            <h1 class="text-2xl font-bold mb-2">Selamat Datang</h1>
            <h2 class="text-xl font-semibold mb-1">Aplikasi Guru Wali</h2>
            <p class="text-white/90 font-medium mb-8">Dwik Setyawan, S.Pd.</p>
            <button onclick="navigateTo('page-home')" class="bg-white text-[#39B5E0] font-bold py-3 px-8 rounded-full shadow-lg hover:bg-gray-100 transform hover:scale-105 transition duration-300 flex items-center justify-center gap-2 mx-auto w-full"><span>Mulai</span><i data-lucide="arrow-right" class="w-5 h-5"></i></button>
        </div>
    </section>

    <!-- Home -->
    <section id="page-home" class="hidden min-h-screen p-4 pt-10 pb-10">
        <div class="max-w-md md:max-w-6xl mx-auto fade-in">
            <div class="bg-white p-6 rounded-2xl shadow-lg mb-8 text-center border-b-4 border-[#39B5E0]"><h2 class="text-gray-800 font-bold text-xl">Dashboard Utama</h2><p class="text-gray-500 text-sm">Silakan pilih menu di bawah ini</p></div>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                <!-- Menu Items -->
                <div onclick="navigateTo('page-program')" class="group cursor-pointer bg-[#A31ACB] p-6 rounded-2xl shadow-lg text-white transform hover:scale-105 transition duration-300 relative overflow-hidden h-40 flex flex-col justify-center"><div class="absolute top-2 right-2 opacity-20"><i data-lucide="calendar-check" class="w-16 h-16"></i></div><h3 class="text-lg font-bold z-10">Program Kegiatan</h3><p class="text-xs opacity-90 mt-1 z-10">Kelola Pilar & Bentuk Kegiatan</p><div class="mt-auto flex items-center text-sm font-semibold z-10">Buka Menu <i data-lucide="chevron-right" class="w-4 h-4 ml-1"></i></div></div>
                <div onclick="navigateTo('page-students')" class="group cursor-pointer bg-[#FF78F0] p-6 rounded-2xl shadow-lg text-white transform hover:scale-105 transition duration-300 relative overflow-hidden h-40 flex flex-col justify-center"><div class="absolute top-2 right-2 opacity-20"><i data-lucide="users" class="w-16 h-16"></i></div><h3 class="text-lg font-bold z-10">Daftar Murid</h3><p class="text-xs opacity-90 mt-1 z-10">Kelola Data & Tahun Ajaran</p><div class="mt-auto flex items-center text-sm font-semibold z-10">Buka Menu <i data-lucide="chevron-right" class="w-4 h-4 ml-1"></i></div></div>
                <div onclick="navigateTo('page-journal')" class="group cursor-pointer bg-[#F5EA5A] p-6 rounded-2xl shadow-lg text-gray-800 transform hover:scale-105 transition duration-300 relative overflow-hidden h-40 flex flex-col justify-center"><div class="absolute top-2 right-2 opacity-20 text-black"><i data-lucide="book-open" class="w-16 h-16"></i></div><h3 class="text-lg font-bold z-10">Jurnal Guru Wali</h3><p class="text-xs opacity-80 mt-1 text-gray-700 z-10">Formulir Catatan Harian</p><div class="mt-auto flex items-center text-sm font-semibold z-10">Buka Menu <i data-lucide="chevron-right" class="w-4 h-4 ml-1"></i></div></div>
                <div onclick="navigateTo('page-recap')" class="group cursor-pointer bg-[#10B981] p-6 rounded-2xl shadow-lg text-white transform hover:scale-105 transition duration-300 relative overflow-hidden h-40 flex flex-col justify-center"><div class="absolute top-2 right-2 opacity-20"><i data-lucide="clipboard-list" class="w-16 h-16"></i></div><h3 class="text-lg font-bold z-10">Rekap Jurnal</h3><p class="text-xs opacity-90 mt-1 z-10">Riwayat & Ekspor Data</p><div class="mt-auto flex items-center text-sm font-semibold z-10">Buka Menu <i data-lucide="chevron-right" class="w-4 h-4 ml-1"></i></div></div>
            </div>
            <div class="mt-12 text-center text-gray-400 text-xs">&copy; 2024 Aplikasi Guru Wali - Dwik Setyawan, S.Pd.</div>
        </div>
    </section>

    <!-- Program Page -->
    <section id="page-program" class="hidden min-h-screen p-4 pb-10">
        <div class="max-w-2xl md:max-w-6xl mx-auto fade-in">
            <div class="bg-[#A31ACB] text-white p-6 rounded-t-2xl shadow-lg flex items-center justify-between sticky top-0 z-10"><div><h2 class="font-bold text-lg">Program Kegiatan</h2><p class="text-xs opacity-90">Rencana Kerja Guru Wali</p></div><button onclick="navigateTo('page-home')" class="bg-white/20 p-2 rounded-full hover:bg-white/30"><i data-lucide="home" class="w-5 h-5"></i></button></div>
            <div class="bg-white p-6 rounded-b-2xl shadow-lg">
                <div class="flex flex-col lg:flex-row gap-8">
                    <div class="lg:w-1/3"><div class="flex justify-between items-center mb-3 border-b-2 border-[#A31ACB] pb-1"><h3 class="text-[#A31ACB] font-bold text-lg">Pilar Program</h3><button onclick="openPillarModal()" class="text-xs bg-purple-100 text-purple-700 px-2 py-1 rounded flex items-center gap-1"><i data-lucide="plus" class="w-3 h-3"></i> Tambah</button></div><div id="pillar-container" class="grid grid-cols-1 gap-3"></div></div>
                    <div class="lg:w-2/3"><div class="flex justify-between items-center mb-3 border-b-2 border-[#A31ACB] pb-1"><h3 class="text-[#A31ACB] font-bold text-lg">Bentuk Kegiatan</h3><button onclick="openActivityModal()" class="text-xs bg-purple-100 text-purple-700 px-2 py-1 rounded flex items-center gap-1"><i data-lucide="plus" class="w-3 h-3"></i> Tambah</button></div><div class="overflow-x-auto"><table class="w-full text-sm text-left text-gray-600 border border-gray-200 rounded-lg overflow-hidden"><thead class="text-xs text-white uppercase bg-[#A31ACB]"><tr><th scope="col" class="px-4 py-3 w-10 text-center">No</th><th scope="col" class="px-4 py-3">Deskripsi Kegiatan</th><th scope="col" class="px-4 py-3 text-center w-20">Aksi</th></tr></thead><tbody id="activity-tbody" class="divide-y divide-gray-100"></tbody></table></div></div>
                </div>
                <div class="mt-8"><button onclick="navigateTo('page-home')" class="w-full bg-gray-100 hover:bg-gray-200 text-gray-700 font-semibold py-3 px-4 rounded-lg flex items-center justify-center gap-2"><i data-lucide="arrow-left" class="w-4 h-4"></i> Kembali ke Home</button></div>
            </div>
        </div>
    </section>

    <!-- Students Page -->
    <section id="page-students" class="hidden min-h-screen p-4 pb-10">
        <div class="max-w-md md:max-w-7xl mx-auto fade-in">
            <div class="bg-[#FF78F0] text-white p-6 rounded-t-2xl shadow-lg sticky top-0 z-10">
                <div class="flex flex-col md:flex-row md:items-center justify-between gap-4"><div><h2 class="font-bold text-lg">Daftar Murid</h2><p class="text-xs opacity-90">Kelola Murid Bimbingan</p></div><div class="flex items-center gap-2 self-end md:self-auto"><button onclick="openAddModal()" class="bg-white text-[#FF78F0] p-2 rounded-full shadow-sm"><i data-lucide="plus" class="w-5 h-5"></i></button><button onclick="navigateTo('page-home')" class="bg-white/20 p-2 rounded-full"><i data-lucide="home" class="w-5 h-5"></i></button></div></div>
                <div class="mt-4 pt-4 border-t border-white/20 flex flex-col md:flex-row gap-3 justify-between items-center">
                    <div class="flex gap-2 w-full md:w-auto">
                        <input type="file" id="importFile" accept=".xlsx, .xls" class="hidden" onchange="handleFileImport(this)">
                        <button onclick="exportToExcel()" class="flex-1 bg-white/20 hover:bg-white/30 text-white text-xs py-2 px-3 rounded-lg flex items-center justify-center gap-2"><i data-lucide="download" class="w-4 h-4"></i> Ekspor</button>
                        <button onclick="document.getElementById('importFile').click()" class="flex-1 bg-white/20 hover:bg-white/30 text-white text-xs py-2 px-3 rounded-lg flex items-center justify-center gap-2"><i data-lucide="upload" class="w-4 h-4"></i> Impor</button>
                        <!-- New Bulk Delete Button -->
                        <button onclick="openBulkDeleteModal()" class="flex-1 bg-white/20 hover:bg-red-500/80 text-white text-xs py-2 px-3 rounded-lg flex items-center justify-center gap-2 transition" title="Hapus Massal">
                            <i data-lucide="trash-2" class="w-4 h-4"></i> Hapus Massal
                        </button>
                    </div>
                    <div class="flex items-center gap-2 w-full md:w-auto justify-end"><label class="text-sm font-medium text-white/90">Filter Tahun:</label><select id="filterAcademicYear" onchange="renderStudents()" class="border-none rounded-lg p-2 text-sm text-[#FF78F0] bg-white cursor-pointer w-1/2 md:w-auto"><option value="all">Semua Tahun</option></select></div>
                </div>
            </div>
            <div class="bg-white p-6 rounded-b-2xl shadow-lg min-h-[400px]">
                <div id="student-list-container" class="space-y-4 md:space-y-0 md:grid md:grid-cols-2 lg:grid-cols-3 md:gap-4"></div>
                <div class="mt-8"><button onclick="navigateTo('page-home')" class="w-full bg-gray-100 hover:bg-gray-200 text-gray-700 font-semibold py-3 px-4 rounded-lg flex items-center justify-center gap-2"><i data-lucide="arrow-left" class="w-4 h-4"></i> Kembali ke Home</button></div>
            </div>
        </div>
    </section>

    <!-- Journal Page -->
    <section id="page-journal" class="hidden min-h-screen p-4 pb-10">
        <div class="max-w-md md:max-w-4xl mx-auto fade-in">
            <div class="bg-[#F5EA5A] text-gray-800 p-6 rounded-t-2xl shadow-lg flex items-center justify-between sticky top-0 z-10"><div><h2 class="font-bold text-lg">Jurnal Guru Wali</h2><p class="text-xs opacity-80">Formulir Catatan Bimbingan</p></div><button onclick="navigateTo('page-home')" class="bg-black/10 p-2 rounded-full"><i data-lucide="home" class="w-5 h-5"></i></button></div>
            <div class="bg-white p-6 rounded-b-2xl shadow-lg">
                <form id="journalForm" onsubmit="submitJournal(event)" class="space-y-4 md:space-y-0 md:grid md:grid-cols-2 md:gap-6">
                    <div><label class="block text-sm font-medium text-gray-700 mb-1">Tanggal</label><input type="date" name="tanggal" required class="w-full p-2 border border-gray-300 rounded-lg"></div>
                    <div><label class="block text-sm font-medium text-gray-700 mb-1">Waktu</label><input type="time" name="waktu" required class="w-full p-2 border border-gray-300 rounded-lg"></div>
                    <div class="md:col-span-2"><label class="block text-sm font-medium text-gray-700 mb-1">Nama Murid Bimbingan</label><input type="text" id="journalName" name="nama" list="dynamic_student_list" oninput="syncStudentData('journal')" placeholder="Ketik nama murid..." required class="w-full p-2 border border-gray-300 rounded-lg"><datalist id="dynamic_student_list"></datalist></div>
                    <div><label class="block text-sm font-medium text-gray-700 mb-1">Kelas</label><input type="text" id="journalClass" name="kelas" placeholder="Contoh: XII IPA 1" required class="w-full p-2 border border-gray-300 rounded-lg"></div>
                    <div><label class="block text-sm font-medium text-gray-700 mb-1">Tahun Ajaran</label><input type="text" id="journalAcademicYear" name="academicYear" placeholder="Contoh: 2024/2025" required class="w-full p-2 border border-gray-300 rounded-lg"></div>
                    <div class="md:col-span-2"><label class="block text-sm font-medium text-gray-700 mb-1">Jenis Bimbingan</label><select name="jenis" required class="w-full p-2 border border-gray-300 rounded-lg bg-white"><option value="" disabled selected>-- Pilih Jenis --</option><option value="Pendampingan Akademik">Pendampingan Akademik</option><option value="Pengembangan Kompetensi">Pengembangan Kompetensi</option><option value="Pengembangan Keterampilan">Pengembangan Keterampilan</option><option value="Pembentukan Karakter">Pembentukan Karakter</option></select></div>
                    <div class="md:col-span-2"><label class="block text-sm font-medium text-gray-700 mb-1">Topik / Permasalahan</label><textarea name="topik" rows="3" required placeholder="Deskripsikan..." class="w-full p-2 border border-gray-300 rounded-lg"></textarea></div>
                    <div class="md:col-span-2"><label class="block text-sm font-medium text-gray-700 mb-1">Tindak Lanjut</label><textarea name="tindak_lanjut" rows="3" required placeholder="Rencana..." class="w-full p-2 border border-gray-300 rounded-lg"></textarea></div>
                    <div class="md:col-span-2 pt-2"><button type="submit" id="btn-submit" class="w-full bg-[#F5EA5A] hover:bg-yellow-300 text-gray-900 font-bold py-3 px-4 rounded-lg shadow-md flex justify-center items-center gap-2"><i data-lucide="save" class="w-4 h-4"></i> Simpan Data</button></div>
                </form>
                <div class="mt-4"><button onclick="navigateTo('page-home')" class="w-full bg-gray-100 hover:bg-gray-200 text-gray-700 font-semibold py-3 px-4 rounded-lg flex items-center justify-center gap-2"><i data-lucide="arrow-left" class="w-4 h-4"></i> Kembali ke Home</button></div>
            </div>
        </div>
    </section>

    <!-- Recap Page -->
    <section id="page-recap" class="hidden min-h-screen p-4 pb-10">
        <div class="max-w-7xl mx-auto fade-in">
            <div class="bg-[#10B981] text-white p-6 rounded-t-2xl shadow-lg flex flex-col md:flex-row items-center justify-between gap-4 sticky top-0 z-10">
                <div><h2 class="font-bold text-lg">Rekap Jurnal</h2><p class="text-xs opacity-90">Riwayat Bimbingan Murid</p></div>
                <div class="flex gap-2 w-full md:w-auto overflow-x-auto pb-2 md:pb-0">
                    <button onclick="openPdfSettings()" class="bg-white/20 p-2 rounded-full w-8 h-8 flex items-center justify-center"><i data-lucide="settings" class="w-4 h-4"></i></button>
                    <button onclick="exportJournalToPdf()" class="bg-white/20 p-2 rounded-full flex items-center gap-1 px-3"><i data-lucide="file-text" class="w-4 h-4"></i> <span class="text-xs font-semibold">PDF</span></button>
                    <button onclick="exportJournalToExcel()" class="bg-white/20 p-2 rounded-full flex items-center gap-1 px-3"><i data-lucide="download" class="w-4 h-4"></i> <span class="text-xs font-semibold">Excel</span></button>
                    <button onclick="navigateTo('page-home')" class="bg-white/20 p-2 rounded-full w-8 h-8 flex items-center justify-center"><i data-lucide="home" class="w-4 h-4"></i></button>
                </div>
            </div>
            <div class="bg-white p-6 rounded-b-2xl shadow-lg overflow-x-auto min-h-[400px]">
                <table class="w-full text-sm text-left text-gray-600 border border-gray-200 rounded-lg">
                    <thead class="text-xs text-white uppercase bg-[#10B981]"><tr><th class="px-4 py-3 rounded-tl-lg">No</th><th class="px-4 py-3">Tanggal</th><th class="px-4 py-3">Nama Murid</th><th class="px-4 py-3 hidden md:table-cell">Kelas</th><th class="px-4 py-3 hidden md:table-cell">Thn Ajaran</th><th class="px-4 py-3">Jenis</th><th class="px-4 py-3 hidden md:table-cell">Topik</th><th class="px-4 py-3 hidden md:table-cell">Tindak</th><th class="px-4 py-3 rounded-tr-lg text-center w-24">Aksi</th></tr></thead>
                    <tbody id="journal-recap-body" class="divide-y divide-gray-100"></tbody>
                </table>
                <div id="empty-journal-msg" class="text-center py-8 text-gray-400 hidden">Belum ada data jurnal.</div>
                <div class="mt-8"><button onclick="navigateTo('page-home')" class="w-full bg-gray-100 hover:bg-gray-200 text-gray-700 font-semibold py-3 px-4 rounded-lg flex items-center justify-center gap-2"><i data-lucide="arrow-left" class="w-4 h-4"></i> Kembali ke Home</button></div>
            </div>
        </div>
    </section>

    <!-- Main Logic -->
    <script>
        // --- DATA ---
        const defaultStudents = [
            { name: "Salirah Aliska", nisn: "1234567890", class: "XII IPA 1", phone: "081234567891", address: "Jl. Mawar No. 1", academicYear: "2024/2025" },
            { name: "Sheina Najla Sabila", nisn: "2345678901", class: "XII IPA 2", phone: "081234567892", address: "Jl. Melati No. 5", academicYear: "2024/2025" },
            { name: "Dina Amalia", nisn: "3456789012", class: "XII IPA 1", phone: "081234567893", address: "Jl. Anggrek No. 10", academicYear: "2024/2025" },
            { name: "Desta Fiara Irawan", nisn: "4567890123", class: "XII IPS 1", phone: "081234567894", address: "Jl. Kenanga No. 3", academicYear: "2024/2025" },
            { name: "Pirman", nisn: "5678901234", class: "XII IPS 2", phone: "081234567895", address: "Jl. Kamboja No. 7", academicYear: "2024/2025" },
            { name: "Muhammad Dearya", nisn: "6789012345", class: "XII IPA 3", phone: "081234567896", address: "Jl. Tulip No. 9", academicYear: "2024/2025" },
            { name: "Hardiansyah Putra", nisn: "7890123456", class: "XII IPA 3", phone: "081234567897", address: "Jl. Dahlia No. 11", academicYear: "2024/2025" }
        ];
        const defaultPillars = [{name:"Pendampingan Akademik",icon:"book"},{name:"Pengembangan Kompetensi",icon:"award"},{name:"Pengembangan Keterampilan",icon:"pen-tool"},{name:"Pengembangan Karakter",icon:"heart"}];
        const defaultActivities = ["Melaksanakan diskusi rutin...","Memberikan saran...","Berkoordinasi dengan guru...","Memberikan informasi...","Mendorong murid...","Observasi perilaku...","Observasi kehadiran...","Sesi diskusi...","Penanganan awal..."];

        // PDF Settings (stored in local storage as preference is per device usually, but can be DB)
        let pdfSettings = JSON.parse(localStorage.getItem('guruWali_pdfSettings')) || { pageSize: 'a4', orientation: 'landscape', marginTop: 15, marginRight: 15, marginBottom: 15, marginLeft: 15 };

        // --- RENDER FUNCTIONS ---
        function renderStudents() {
            const container = document.getElementById('student-list-container');
            const filterValue = document.getElementById('filterAcademicYear').value;
            container.innerHTML = '';
            
            const filteredStudents = window.students.filter(s => filterValue === 'all' || (s.academicYear || "-") === filterValue);

            if (filteredStudents.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-400 py-4 col-span-full">Belum ada data murid.</p>';
                return;
            }

            filteredStudents.forEach((student, index) => {
                const el = document.createElement('div');
                el.className = 'bg-white border border-gray-100 rounded-lg p-4 shadow-sm hover:shadow-md transition duration-200 relative group';
                const imgSrc = student.photo ? student.photo : '';
                const imgDisplay = imgSrc ? `<img src="${imgSrc}" class="w-full h-full object-cover">` : `<div class="w-full h-full flex items-center justify-center bg-pink-100 text-[#FF78F0] font-bold text-lg">${index + 1}</div>`;

                el.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div class="flex items-start gap-3 w-full">
                            <div class="w-12 h-12 rounded-full bg-gray-100 flex-shrink-0 overflow-hidden border border-gray-100">${imgDisplay}</div>
                            <div class="flex-1 min-w-0">
                                <h4 class="font-bold text-gray-800 truncate">${student.name}</h4>
                                <div class="flex items-center gap-2 flex-wrap">
                                    <p class="text-xs text-[#FF78F0] font-semibold">${student.class}</p>
                                    <span class="text-[10px] bg-gray-100 text-gray-600 px-1.5 py-0.5 rounded border border-gray-200">NISN: ${student.nisn || "-"}</span>
                                </div>
                                <div class="mt-1 text-xs text-gray-500 space-y-0.5">
                                    <p class="flex items-center gap-1 truncate"><i class="w-3 h-3 flex-shrink-0" data-lucide="phone"></i> ${student.phone}</p>
                                    <p class="flex items-center gap-1 truncate"><i class="w-3 h-3 flex-shrink-0" data-lucide="map-pin"></i> ${student.address}</p>
                                    <p class="text-[10px] text-gray-400 mt-1">TA: ${student.academicYear || "-"}</p>
                                </div>
                            </div>
                        </div>
                        <div class="flex gap-1 flex-shrink-0 ml-2">
                            <button onclick="editStudent('${student.id}')" class="text-gray-400 hover:text-blue-500 transition p-1"><i data-lucide="pencil" class="w-4 h-4"></i></button>
                            <button onclick="deleteStudent('${student.id}')" class="text-gray-400 hover:text-red-500 transition p-1"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                        </div>
                    </div>`;
                container.appendChild(el);
            });
            lucide.createIcons();
        }

        function renderFilterOptions() {
            const filterSelect = document.getElementById('filterAcademicYear');
            const currentVal = filterSelect.value;
            const years = [...new Set(window.students.map(s => s.academicYear || "-"))].sort().reverse();
            filterSelect.innerHTML = '<option value="all">Semua Tahun</option>';
            years.forEach(year => {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year === "-" ? "Tanpa Tahun" : year;
                filterSelect.appendChild(option);
            });
            if ([...filterSelect.options].some(o => o.value === currentVal)) filterSelect.value = currentVal;
        }

        // --- NEW: Bulk Delete Modal Functions ---
        function openBulkDeleteModal() {
            // Get unique years
            const years = [...new Set(window.students.map(s => s.academicYear || "-"))].sort().reverse();
            // Get unique classes
            const classes = [...new Set(window.students.map(s => s.class || "-"))].sort();

            const yearSelect = document.getElementById('bulkDeleteYear');
            const classSelect = document.getElementById('bulkDeleteClass');

            yearSelect.innerHTML = '<option value="">-- Pilih Tahun Ajaran --</option>';
            years.forEach(y => {
                const opt = document.createElement('option');
                opt.value = y;
                opt.text = y === "-" ? "Tanpa Tahun" : y;
                yearSelect.appendChild(opt);
            });

            classSelect.innerHTML = '<option value="">-- Pilih Kelas --</option>';
            classes.forEach(c => {
                const opt = document.createElement('option');
                opt.value = c;
                opt.text = c === "-" ? "Tanpa Kelas" : c;
                classSelect.appendChild(opt);
            });

            document.getElementById('bulkDeleteModal').classList.remove('hidden');
        }

        function closeBulkDeleteModal() {
            document.getElementById('bulkDeleteModal').classList.add('hidden');
        }

        function confirmBulkDelete() {
            const year = document.getElementById('bulkDeleteYear').value;
            const className = document.getElementById('bulkDeleteClass').value;

            if (!year && !className) {
                Swal.fire('Error', 'Pilih minimal Tahun Ajaran atau Kelas.', 'error');
                return;
            }

            window.bulkDeleteStudentsDB(year, className);
        }

        function renderProgram() {
            const pillarContainer = document.getElementById('pillar-container');
            pillarContainer.innerHTML = '';
            window.pillars.forEach((pillar, index) => {
                const el = document.createElement('div');
                el.className = 'bg-purple-50 p-3 rounded-lg border-l-4 border-[#A31ACB] flex items-center justify-between group';
                el.innerHTML = `<div class="flex items-center gap-2"><i data-lucide="${pillar.icon}" class="w-4 h-4 text-[#A31ACB]"></i><span class="text-sm font-medium">${pillar.name}</span></div><div class="flex gap-1 opacity-0 group-hover:opacity-100 transition"><button onclick="editPillar(${index})" class="text-gray-400 hover:text-blue-500"><i data-lucide="pencil" class="w-3 h-3"></i></button><button onclick="deletePillar(${index})" class="text-gray-400 hover:text-red-500"><i data-lucide="trash-2" class="w-3 h-3"></i></button></div>`;
                pillarContainer.appendChild(el);
            });
            const activityTbody = document.getElementById('activity-tbody');
            activityTbody.innerHTML = '';
            window.activities.forEach((activity, index) => {
                const row = document.createElement('tr');
                row.className = index % 2 === 0 ? 'bg-white hover:bg-gray-50' : 'bg-purple-50 hover:bg-purple-100';
                row.innerHTML = `<td class="px-4 py-3 text-center font-bold text-[#A31ACB]">${index + 1}</td><td class="px-4 py-3">${activity}</td><td class="px-4 py-3 text-center"><div class="flex justify-center gap-2"><button onclick="editActivity(${index})" class="text-gray-400 hover:text-blue-500"><i data-lucide="pencil" class="w-3 h-3"></i></button><button onclick="deleteActivity(${index})" class="text-gray-400 hover:text-red-500"><i data-lucide="trash-2" class="w-3 h-3"></i></button></div></td>`;
                activityTbody.appendChild(row);
            });
            lucide.createIcons();
        }

        function renderJournalRecap() {
            const tbody = document.getElementById('journal-recap-body');
            const emptyMsg = document.getElementById('empty-journal-msg');
            tbody.innerHTML = '';
            if (window.journals.length === 0) { emptyMsg.classList.remove('hidden'); } 
            else {
                emptyMsg.classList.add('hidden');
                window.journals.forEach((j, index) => {
                    const row = document.createElement('tr');
                    row.className = "bg-white hover:bg-gray-50 border-b border-gray-100";
                    row.innerHTML = `<td class="px-4 py-3 font-bold text-emerald-600 text-center">${window.journals.length - index}</td><td class="px-4 py-3 whitespace-nowrap">${j.tanggal} <span class="text-xs text-gray-400 block">${j.waktu}</span></td><td class="px-4 py-3 font-medium text-gray-800">${j.nama}</td><td class="px-4 py-3 hidden md:table-cell">${j.kelas}</td><td class="px-4 py-3 text-xs text-gray-600 hidden md:table-cell">${j.academicYear || '-'}</td><td class="px-4 py-3"><span class="bg-emerald-100 text-emerald-800 text-xs px-2 py-1 rounded-full whitespace-nowrap">${j.jenis}</span></td><td class="px-4 py-3 max-w-xs truncate hidden md:table-cell" title="${j.topik}">${j.topik}</td><td class="px-4 py-3 max-w-xs truncate hidden md:table-cell" title="${j.tindak_lanjut}">${j.tindak_lanjut}</td><td class="px-4 py-3 text-center"><div class="flex items-center justify-center gap-2"><button onclick="editJournal('${j.id}')" class="text-gray-400 hover:text-blue-500 transition p-1"><i data-lucide="pencil" class="w-4 h-4"></i></button><button onclick="deleteJournal('${j.id}')" class="text-gray-400 hover:text-red-500 transition p-1"><i data-lucide="trash-2" class="w-4 h-4"></i></button></div></td>`;
                    tbody.appendChild(row);
                });
            }
            lucide.createIcons();
        }

        function renderJournalDatalist() {
            const listIds = ['dynamic_student_list', 'dynamic_student_list_modal'];
            listIds.forEach(id => {
                const datalist = document.getElementById(id);
                if (datalist) {
                    datalist.innerHTML = '';
                    window.students.forEach(student => {
                        const option = document.createElement('option');
                        option.value = student.name;
                        datalist.appendChild(option);
                    });
                }
            });
        }

        // --- CRUD LOGIC Handlers ---
        
        function openAddModal() {
            document.getElementById('studentId').value = ''; 
            document.getElementById('modal-title').innerText = 'Tambah Murid Baru';
            document.getElementById('studentName').value = '';
            document.getElementById('studentNisn').value = '';
            document.getElementById('studentClass').value = '';
            document.getElementById('studentPhone').value = '';
            document.getElementById('studentAddress').value = '';
            document.getElementById('studentAcademicYear').value = '2024/2025';
            document.getElementById('studentPhoto').value = '';
            document.getElementById('studentPhotoPreview').src = '';
            document.getElementById('studentPhotoPreview').classList.add('hidden');
            document.getElementById('studentPhotoPlaceholder').classList.remove('hidden');
            document.getElementById('studentModal').classList.remove('hidden');
        }
        function closeStudentModal() { document.getElementById('studentModal').classList.add('hidden'); }
        
        function editStudent(id) {
            const student = window.students.find(s => s.id === id);
            if (!student) return;
            document.getElementById('studentId').value = id;
            document.getElementById('modal-title').innerText = 'Edit Data Murid';
            document.getElementById('studentName').value = student.name;
            document.getElementById('studentNisn').value = student.nisn || "";
            document.getElementById('studentClass').value = student.class;
            document.getElementById('studentPhone').value = student.phone;
            document.getElementById('studentAddress').value = student.address;
            document.getElementById('studentAcademicYear').value = student.academicYear || "2024/2025";
            const preview = document.getElementById('studentPhotoPreview');
            const placeholder = document.getElementById('studentPhotoPlaceholder');
            if (student.photo) { preview.src = student.photo; preview.classList.remove('hidden'); placeholder.classList.add('hidden'); } 
            else { preview.src = ''; preview.classList.add('hidden'); placeholder.classList.remove('hidden'); }
            document.getElementById('studentPhoto').value = '';
            document.getElementById('studentModal').classList.remove('hidden');
        }

        async function saveStudent() {
            const id = document.getElementById('studentId').value;
            const name = document.getElementById('studentName').value;
            const nisn = document.getElementById('studentNisn').value;
            const className = document.getElementById('studentClass').value;
            const phone = document.getElementById('studentPhone').value;
            const address = document.getElementById('studentAddress').value;
            const academicYear = document.getElementById('studentAcademicYear').value;
            const photoInput = document.getElementById('studentPhoto');
            const btnSave = document.getElementById('btnSaveStudent');

            if (!name || !className) { Swal.fire('Oops...', 'Nama dan Kelas wajib diisi!', 'error'); return; }

            // Set loading state
            const originalText = btnSave.innerText;
            btnSave.disabled = true;
            btnSave.innerText = 'Menyimpan...';

            try {
                const finalizeSave = async (photoData) => {
                    const studentData = { name, nisn, class: className, phone, address, academicYear, photo: photoData };
                    await window.saveStudentDB(studentData, id || null);
                };

                if (photoInput.files && photoInput.files[0]) {
                    const reader = new FileReader();
                    reader.onload = async function(e) { await finalizeSave(e.target.result); };
                    reader.readAsDataURL(photoInput.files[0]);
                } else {
                    let existingPhoto = null;
                    if (id) { const s = window.students.find(s => s.id === id); if(s) existingPhoto = s.photo; }
                    await finalizeSave(existingPhoto);
                }
            } catch (error) {
                console.error("Save error:", error);
            } finally {
                // Restore button state
                btnSave.disabled = false;
                btnSave.innerText = originalText;
            }
        }

        function deleteStudent(id) {
            Swal.fire({ title: 'Hapus data?', icon: 'warning', showCancelButton: true, confirmButtonText: 'Ya, Hapus!', }).then((result) => {
                if (result.isConfirmed) { window.deleteStudentDB(id); }
            });
        }

        function previewImage(input) {
            const preview = document.getElementById('studentPhotoPreview');
            const placeholder = document.getElementById('studentPhotoPlaceholder');
            const file = input.files[0];
            if (file) {
                if (file.size > 500 * 1024) {
                    Swal.fire({ icon: 'error', title: 'File Terlalu Besar', text: 'Maksimal 500KB!', confirmButtonColor: '#FF78F0' });
                    input.value = ''; preview.src = ''; preview.classList.add('hidden'); placeholder.classList.remove('hidden');
                    return;
                }
                const reader = new FileReader();
                reader.onload = function(e) { preview.src = e.target.result; preview.classList.remove('hidden'); placeholder.classList.add('hidden'); }
                reader.readAsDataURL(file);
            }
        }

        // Program Logic
        function savePillar() {
            const index = parseInt(document.getElementById('pillarIndex').value);
            const name = document.getElementById('pillarName').value;
            const icon = document.getElementById('pillarIcon').value;
            if (!name) return;
            const data = { name, icon };
            if (index === -1) window.pillars.push(data); else window.pillars[index] = data;
            window.saveProgramDB('pillars', window.pillars);
            closePillarModal();
        }
        function deletePillar(index) {
            Swal.fire({ title: 'Hapus?', icon: 'warning', showCancelButton: true, confirmButtonText: 'Ya' }).then(res => {
                if(res.isConfirmed) { window.pillars.splice(index, 1); window.saveProgramDB('pillars', window.pillars); }
            });
        }
        // ... (Similar logic for activities)
        function saveActivity() {
            const index = parseInt(document.getElementById('activityIndex').value);
            const desc = document.getElementById('activityDesc').value;
            if(!desc) return;
            if(index === -1) window.activities.push(desc); else window.activities[index] = desc;
            window.saveProgramDB('activities', window.activities);
            closeActivityModal();
        }
        function deleteActivity(index) {
             Swal.fire({ title: 'Hapus?', icon: 'warning', showCancelButton: true, confirmButtonText: 'Ya' }).then(res => {
                if(res.isConfirmed) { window.activities.splice(index, 1); window.saveProgramDB('activities', window.activities); }
            });
        }

        // Journal Logic
        function submitJournal(e) {
            e.preventDefault();
            const form = document.getElementById('journalForm');
            const formData = new FormData(form);
            const data = Object.fromEntries(formData.entries());
            window.saveJournalDB(data);
            form.reset();
            setTimeout(() => navigateTo('page-recap'), 500);
        }
        function editJournal(id) {
            const journal = window.journals.find(j => j.id === id);
            if (!journal) return;
            document.getElementById('editJournalId').value = id;
            document.getElementById('editJournalDate').value = journal.tanggal;
            document.getElementById('editJournalTime').value = journal.waktu;
            document.getElementById('editJournalName').value = journal.nama;
            document.getElementById('editJournalClass').value = journal.kelas;
            document.getElementById('editJournalAcademicYear').value = journal.academicYear || "";
            document.getElementById('editJournalType').value = journal.jenis;
            document.getElementById('editJournalTopic').value = journal.topik;
            document.getElementById('editJournalAction').value = journal.tindak_lanjut;
            document.getElementById('journalModal').classList.remove('hidden');
        }
        function closeJournalModal() { document.getElementById('journalModal').classList.add('hidden'); }
        function saveJournalEdit() {
            const id = document.getElementById('editJournalId').value;
            const updatedJournal = {
                tanggal: document.getElementById('editJournalDate').value,
                waktu: document.getElementById('editJournalTime').value,
                nama: document.getElementById('editJournalName').value,
                kelas: document.getElementById('editJournalClass').value,
                academicYear: document.getElementById('editJournalAcademicYear').value,
                jenis: document.getElementById('editJournalType').value,
                topik: document.getElementById('editJournalTopic').value,
                tindak_lanjut: document.getElementById('editJournalAction').value
            };
            window.saveJournalDB(updatedJournal, id);
        }
        function deleteJournal(id) {
            Swal.fire({ title: 'Hapus?', icon: 'warning', showCancelButton: true, confirmButtonColor: '#d33', confirmButtonText: 'Ya' }).then((result) => {
                if (result.isConfirmed) { window.deleteJournalDB(id); }
            });
        }

        // --- Helpers ---
        function syncStudentData(prefix) {
            const nameInput = document.getElementById(prefix + 'Name');
            const classInput = document.getElementById(prefix + 'Class');
            const academicYearInput = document.getElementById(prefix + 'AcademicYear');
            const student = window.students.find(s => s.name === nameInput.value);
            if (student) {
                classInput.value = student.class; classInput.classList.add('bg-yellow-50');
                if (academicYearInput) { academicYearInput.value = student.academicYear || ""; academicYearInput.classList.add('bg-yellow-50'); }
                setTimeout(() => { classInput.classList.remove('bg-yellow-50'); if(academicYearInput) academicYearInput.classList.remove('bg-yellow-50'); }, 500);
            }
        }

        function exportToExcel() {
            const excelData = window.students.map((s, index) => ({ "No": index + 1, "NISN": s.nisn || "-", "Nama": s.name, "Kelas": s.class, "HP": s.phone, "Alamat": s.address, "Tahun Ajaran": s.academicYear || "-" }));
            const worksheet = XLSX.utils.json_to_sheet(excelData);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, "Daftar Murid");
            XLSX.writeFile(workbook, `Data_Murid_${new Date().toISOString().slice(0, 10)}.xlsx`);
        }

        function exportJournalToExcel() {
            if (window.journals.length === 0) { Swal.fire('Info', 'Belum ada data.', 'info'); return; }
            const excelData = window.journals.map((j, index) => ({ "No": index + 1, "Tanggal": j.tanggal, "Waktu": j.waktu, "Nama Siswa": j.nama, "Kelas": j.kelas, "Tahun Ajaran": j.academicYear, "Jenis Bimbingan": j.jenis, "Topik": j.topik, "Tindak Lanjut": j.tindak_lanjut }));
            const worksheet = XLSX.utils.json_to_sheet(excelData);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, "Rekap Jurnal");
            XLSX.writeFile(workbook, `Rekap_Jurnal_${new Date().toISOString().slice(0, 10)}.xlsx`);
        }

        async function handleFileImport(input) {
            const file = input.files[0];
            if (!file) return;
            
            // Show loading
            Swal.fire({
                title: 'Memproses Data...',
                text: 'Mohon tunggu sebentar.',
                allowOutsideClick: false,
                didOpen: () => { Swal.showLoading() }
            });

            const reader = new FileReader();
            reader.onload = async function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    const jsonData = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
                    
                    if (jsonData.length === 0) { 
                        Swal.fire('Gagal', 'File kosong.', 'error'); 
                        input.value = '';
                        return; 
                    }

                    const result = await Swal.fire({
                        title: 'Impor Data?', 
                        text: `Ditemukan ${jsonData.length} data. Tambahkan ke database?`, 
                        icon: 'question', 
                        showCancelButton: true, 
                        confirmButtonText: 'Ya, Tambahkan'
                    });

                    if (result.isConfirmed) {
                        // Show processing alert
                        Swal.fire({
                            title: 'Sedang Mengunggah...',
                            html: 'Mohon jangan tutup halaman ini.',
                            allowOutsideClick: false,
                            didOpen: () => { Swal.showLoading() }
                        });

                        let successCount = 0;
                        for (const row of jsonData) {
                            // Flexible key mapping helper
                            const getVal = (keys) => {
                                for (let k of keys) if (row[k] !== undefined) return row[k];
                                const rowKeys = Object.keys(row);
                                for (let k of keys) {
                                    const found = rowKeys.find(rk => rk.toLowerCase() === k.toLowerCase());
                                    if (found) return row[found];
                                }
                                return null;
                            };

                            const newStudent = {
                                name: getVal(['Nama', 'Nama Lengkap', 'Nama Siswa', 'Student Name']) || "Tanpa Nama",
                                nisn: getVal(['NISN', 'Nomor Induk']) || "-",
                                class: getVal(['Kelas', 'Class', 'Rombel']) || "-",
                                phone: getVal(['HP', 'No HP', 'No. HP', 'Nomor HP', 'WhatsApp', 'WA']) || "-",
                                address: getVal(['Alamat', 'Address']) || "-",
                                academicYear: getVal(['Tahun', 'Tahun Ajaran', 'Academic Year', 'TA']) || "2024/2025"
                            };
                            
                            // Basic validation
                            if (newStudent.name && newStudent.name !== "Tanpa Nama") {
                                await window.saveStudentDB(newStudent, null, true); // silent = true
                                successCount++;
                            }
                        }
                        Swal.fire('Selesai', `${successCount} data berhasil ditambahkan.`, 'success');
                    }
                } catch (error) { 
                    console.error(error);
                    Swal.fire('Error', 'Gagal membaca file. Pastikan format Excel benar.', 'error'); 
                }
                input.value = '';
            };
            reader.readAsArrayBuffer(file);
        }

        // Modal Helpers (duplicated for clarity if needed, or reused from above)
        function openPillarModal() { document.getElementById('pillarIndex').value = '-1'; document.getElementById('pillarName').value = ''; document.getElementById('pillarModal').classList.remove('hidden'); }
        function closePillarModal() { document.getElementById('pillarModal').classList.add('hidden'); }
        function editPillar(index) { document.getElementById('pillarIndex').value = index; document.getElementById('pillarName').value = window.pillars[index].name; document.getElementById('pillarIcon').value = window.pillars[index].icon; document.getElementById('pillarModal').classList.remove('hidden'); }
        
        function openActivityModal() { document.getElementById('activityIndex').value = '-1'; document.getElementById('activityDesc').value = ''; document.getElementById('activityModal').classList.remove('hidden'); }
        function closeActivityModal() { document.getElementById('activityModal').classList.add('hidden'); }
        function editActivity(index) { document.getElementById('activityIndex').value = index; document.getElementById('activityDesc').value = window.activities[index]; document.getElementById('activityModal').classList.remove('hidden'); }

        function navigateTo(pageId) {
            document.querySelectorAll('section').forEach(p => { p.classList.add('hidden'); p.querySelector('.fade-in')?.classList.remove('fade-in'); });
            const selected = document.getElementById(pageId);
            selected.classList.remove('hidden');
            setTimeout(() => selected.querySelector('div').classList.add('fade-in'), 10);
            window.scrollTo(0,0);
        }

        function showToast(title, message, type) {
            const toast = document.getElementById('toast');
            const container = toast.querySelector('div');
            document.getElementById('toast-title').textContent = title;
            document.getElementById('toast-message').textContent = message;
            container.className = type === 'success' ? "bg-white border-l-4 border-green-500 shadow-lg rounded-lg p-4 w-72 flex items-center gap-3" : "bg-white border-l-4 border-red-500 shadow-lg rounded-lg p-4 w-72 flex items-center gap-3";
            document.getElementById('toast-icon').innerHTML = type === 'success' ? `<i data-lucide="check-circle" class="w-6 h-6 text-green-500"></i>` : `<i data-lucide="alert-circle" class="w-6 h-6 text-red-500"></i>`;
            lucide.createIcons();
            toast.classList.remove('translate-x-full', 'opacity-0');
            setTimeout(() => toast.classList.add('translate-x-full', 'opacity-0'), 3000);
        }

        // PDF Logic (Keep existing)
        function openPdfSettings() { document.getElementById('pdfSettingsModal').classList.remove('hidden'); }
        function closePdfSettings() { 
            pdfSettings.pageSize = document.getElementById('pdfSize').value;
            pdfSettings.orientation = document.querySelector('input[name="pdfOrientation"]:checked').value;
            pdfSettings.marginTop = Number(document.getElementById('pdfMarginTop').value);
            pdfSettings.marginRight = Number(document.getElementById('pdfMarginRight').value);
            pdfSettings.marginBottom = Number(document.getElementById('pdfMarginBottom').value);
            pdfSettings.marginLeft = Number(document.getElementById('pdfMarginLeft').value);
            localStorage.setItem('guruWali_pdfSettings', JSON.stringify(pdfSettings));
            document.getElementById('pdfSettingsModal').classList.add('hidden');
        }
        function exportJournalToPdf() {
            if (window.journals.length === 0) { Swal.fire('Info', 'Belum ada data jurnal.', 'info'); return; }
            const { jsPDF } = window.jspdf;
            let format = pdfSettings.pageSize === 'f4' ? [215, 330] : pdfSettings.pageSize;
            const doc = new jsPDF({ orientation: pdfSettings.orientation, unit: 'mm', format: format });
            doc.setFontSize(16); doc.text("Rekap Jurnal Guru Wali", pdfSettings.marginLeft, pdfSettings.marginTop);
            doc.setFontSize(12); doc.text("Dwik Setyawan, S.Pd.", pdfSettings.marginLeft, pdfSettings.marginTop + 7);
            const headers = [['No', 'Tanggal', 'Waktu', 'Nama Murid', 'Kelas', 'Thn Ajaran', 'Jenis', 'Topik', 'Tindak Lanjut']];
            const data = window.journals.map((j, index) => [index + 1, j.tanggal, j.waktu, j.nama, j.kelas, j.academicYear || '-', j.jenis, j.topik, j.tindak_lanjut]);
            doc.autoTable({ head: headers, body: data, startY: pdfSettings.marginTop + 15, margin: { top: pdfSettings.marginTop, right: pdfSettings.marginRight, bottom: pdfSettings.marginBottom, left: pdfSettings.marginLeft }, styles: { fontSize: 8, cellPadding: 2 }, headStyles: { fillColor: [16, 185, 129] }, theme: 'grid' });
            doc.save(`Jurnal_Wali_${new Date().toISOString().slice(0,10)}.pdf`);
        }

        lucide.createIcons();
    </script>
</body>
</html>
