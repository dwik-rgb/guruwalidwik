<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aplikasi Guru Wali - Dwik Setyawan, S.Pd.</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <!-- SheetJS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- jsPDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>
    
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot, setDoc, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        let db, auth, currentUser;
        let useLocalStorage = false;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // --- GLOBAL DATA ---
        window.students = [];
        window.journals = [];
        window.pillars = [];
        window.activities = [];
        
        // --- DEFAULTS ---
        const defaultPillars = [
            { name: "Pendampingan Akademik", icon: "book" },
            { name: "Pengembangan Kompetensi", icon: "award" },
            { name: "Pengembangan Keterampilan", icon: "pen-tool" },
            { name: "Pengembangan Karakter", icon: "heart" }
        ];
        const defaultActivities = [
            "Melaksanakan diskusi rutin perkembangan nilai.",
            "Memberikan saran strategi belajar.",
            "Koordinasi dengan guru mapel.",
            "Info lomba/seminar.",
            "Mendorong partisipasi organisasi.",
            "Observasi perilaku.",
            "Observasi kehadiran.",
            "Sesi konseling.",
            "Penanganan masalah perilaku."
        ];

        // --- INIT ---
        async function initApp() {
            try {
                if (typeof __firebase_config === 'undefined') throw new Error("Config missing");
                const firebaseConfig = JSON.parse(__firebase_config);
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        currentUser = user;
                        console.log("Online Mode: Connected as", user.uid);
                        setupListeners(user.uid);
                    }
                });
            } catch (e) {
                console.warn("Offline Mode Active (Local Storage)");
                useLocalStorage = true;
                loadFromLocalStorage();
            }
        }

        function setupListeners(userId) {
            // Students
            onSnapshot(collection(db, 'artifacts', appId, 'users', userId, 'students'), (snap) => {
                window.students = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                window.refreshUI();
            });
            // Journals
            onSnapshot(collection(db, 'artifacts', appId, 'users', userId, 'journals'), (snap) => {
                window.journals = snap.docs.map(d => ({ id: d.id, ...d.data() })).sort((a, b) => new Date(b.tanggal) - new Date(a.tanggal));
                window.refreshUI();
            });
            // Program (Settings)
            onSnapshot(doc(db, 'artifacts', appId, 'users', userId, 'settings', 'program'), (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    window.pillars = data.pillars || defaultPillars;
                    window.activities = data.activities || defaultActivities;
                } else {
                    window.pillars = defaultPillars;
                    window.activities = defaultActivities;
                    setDoc(doc(db, 'artifacts', appId, 'users', userId, 'settings', 'program'), { pillars: defaultPillars, activities: defaultActivities });
                }
                window.refreshUI();
            });
        }

        function loadFromLocalStorage() {
            window.students = JSON.parse(localStorage.getItem('guruWali_students')) || [];
            window.journals = JSON.parse(localStorage.getItem('guruWali_journals')) || [];
            window.pillars = JSON.parse(localStorage.getItem('guruWali_pillars')) || defaultPillars;
            window.activities = JSON.parse(localStorage.getItem('guruWali_activities')) || defaultActivities;
            window.refreshUI();
        }

        // --- CRUD HELPERS (Global Access) ---
        window.dbSaveStudent = async (data, id) => {
            if (useLocalStorage) {
                if(id) { const i = window.students.findIndex(s => s.id === id); if(i>-1) window.students[i] = {...window.students[i], ...data}; }
                else { data.id = Date.now().toString(); window.students.push(data); }
                localStorage.setItem('guruWali_students', JSON.stringify(window.students));
            } else {
                const col = collection(db, 'artifacts', appId, 'users', currentUser.uid, 'students');
                if(id) await updateDoc(doc(col, id), data); else await addDoc(col, data);
            }
            window.refreshUI();
        };

        window.dbSaveJournal = async (data, id) => {
            if (useLocalStorage) {
                if(id) { const i = window.journals.findIndex(j => j.id === id); if(i>-1) window.journals[i] = {...window.journals[i], ...data}; }
                else { data.id = Date.now().toString(); window.journals.push(data); }
                localStorage.setItem('guruWali_journals', JSON.stringify(window.journals));
            } else {
                const col = collection(db, 'artifacts', appId, 'users', currentUser.uid, 'journals');
                if(id) await updateDoc(doc(col, id), data); else await addDoc(col, data);
            }
            window.refreshUI();
        };

        window.dbSaveProgram = async (type, data) => {
            if (type === 'pillars') window.pillars = data; else window.activities = data;
            if (useLocalStorage) {
                localStorage.setItem('guruWali_' + type, JSON.stringify(data));
            } else {
                const docRef = doc(db, 'artifacts', appId, 'users', currentUser.uid, 'settings', 'program');
                await setDoc(docRef, { pillars: window.pillars, activities: window.activities }, { merge: true });
            }
            window.refreshUI();
        };

        window.dbDeleteStudent = async (id) => {
            if(useLocalStorage) {
                window.students = window.students.filter(s => s.id !== id);
                localStorage.setItem('guruWali_students', JSON.stringify(window.students));
            } else {
                await deleteDoc(doc(db, 'artifacts', appId, 'users', currentUser.uid, 'students', id));
            }
            window.refreshUI();
        };

        window.dbDeleteJournal = async (id) => {
            if(useLocalStorage) {
                window.journals = window.journals.filter(j => j.id !== id);
                localStorage.setItem('guruWali_journals', JSON.stringify(window.journals));
            } else {
                await deleteDoc(doc(db, 'artifacts', appId, 'users', currentUser.uid, 'journals', id));
            }
            window.refreshUI();
        };

        window.dbBulkDeleteStudents = async (ids) => {
            if(useLocalStorage) {
                window.students = window.students.filter(s => !ids.includes(s.id));
                localStorage.setItem('guruWali_students', JSON.stringify(window.students));
            } else {
                const batch = writeBatch(db);
                ids.forEach(id => {
                    batch.delete(doc(db, 'artifacts', appId, 'users', currentUser.uid, 'students', id));
                });
                await batch.commit();
            }
            window.refreshUI();
        };

        initApp();
    </script>

    <style>
        .glass-panel { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); }
        .form-input { @apply w-full border border-gray-300 rounded-lg p-2 focus:ring-2 focus:ring-blue-400 focus:border-transparent outline-none transition; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <!-- TOAST -->
    <div id="toast" class="fixed top-5 right-5 z-[100] transform transition-all duration-300 translate-x-full opacity-0 pointer-events-none">
        <div class="bg-white border-l-4 shadow-lg rounded-lg p-4 w-72 flex items-center gap-3 pointer-events-auto">
            <div id="toast-icon"></div>
            <div>
                <h4 id="toast-title" class="font-bold text-sm"></h4>
                <p id="toast-message" class="text-xs text-gray-600"></p>
            </div>
        </div>
    </div>

    <!-- LANDING PAGE -->
    <section id="page-landing" class="flex flex-col items-center justify-center min-h-screen p-6 bg-gradient-to-br from-blue-500 to-cyan-400 text-white">
        <div class="bg-white/20 backdrop-blur-md p-8 rounded-3xl shadow-2xl text-center max-w-sm w-full border border-white/30">
            <div class="bg-white text-blue-500 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-6 shadow-lg">
                <i data-lucide="graduation-cap" class="w-8 h-8"></i>
            </div>
            <h1 class="text-3xl font-bold mb-2">Guru Wali</h1>
            <p class="text-white/90 mb-8 font-medium">Aplikasi Pendampingan Siswa</p>
            <button onclick="nav('page-home')" class="w-full bg-white text-blue-600 font-bold py-3 rounded-xl shadow-lg hover:bg-gray-50 hover:scale-105 transition transform flex items-center justify-center gap-2">
                Mulai Sekarang <i data-lucide="arrow-right" class="w-4 h-4"></i>
            </button>
        </div>
        <p class="mt-8 text-white/60 text-xs">Dwik Setyawan, S.Pd.</p>
    </section>

    <!-- HOME DASHBOARD -->
    <section id="page-home" class="hidden min-h-screen p-6">
        <div class="max-w-6xl mx-auto space-y-6">
            <div class="bg-white p-6 rounded-2xl shadow-sm border-l-4 border-blue-500 flex justify-between items-center">
                <div>
                    <h2 class="text-xl font-bold text-gray-800">Dashboard Utama</h2>
                    <p class="text-sm text-gray-500">Selamat datang di panel kontrol.</p>
                </div>
                <div class="text-right hidden sm:block">
                    <p class="text-xs text-gray-400" id="current-date"></p>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                <!-- Menu Cards -->
                <div onclick="nav('page-program')" class="bg-white p-6 rounded-2xl shadow-sm hover:shadow-md transition cursor-pointer border border-gray-100 group relative overflow-hidden">
                    <div class="absolute right-[-10px] top-[-10px] opacity-5 transform rotate-12 transition group-hover:scale-110 group-hover:opacity-10"><i data-lucide="calendar-check" class="w-32 h-32 text-purple-600"></i></div>
                    <div class="w-12 h-12 rounded-xl bg-purple-100 text-purple-600 flex items-center justify-center mb-4"><i data-lucide="calendar-check" class="w-6 h-6"></i></div>
                    <h3 class="font-bold text-gray-800">Program Kegiatan</h3>
                    <p class="text-xs text-gray-500 mt-1">Kelola pilar & aktivitas.</p>
                </div>

                <div onclick="nav('page-students')" class="bg-white p-6 rounded-2xl shadow-sm hover:shadow-md transition cursor-pointer border border-gray-100 group relative overflow-hidden">
                    <div class="absolute right-[-10px] top-[-10px] opacity-5 transform rotate-12 transition group-hover:scale-110 group-hover:opacity-10"><i data-lucide="users" class="w-32 h-32 text-pink-500"></i></div>
                    <div class="w-12 h-12 rounded-xl bg-pink-100 text-pink-500 flex items-center justify-center mb-4"><i data-lucide="users" class="w-6 h-6"></i></div>
                    <h3 class="font-bold text-gray-800">Daftar Murid</h3>
                    <p class="text-xs text-gray-500 mt-1">Data siswa & profil.</p>
                </div>

                <div onclick="nav('page-journal')" class="bg-white p-6 rounded-2xl shadow-sm hover:shadow-md transition cursor-pointer border border-gray-100 group relative overflow-hidden">
                    <div class="absolute right-[-10px] top-[-10px] opacity-5 transform rotate-12 transition group-hover:scale-110 group-hover:opacity-10"><i data-lucide="book-open" class="w-32 h-32 text-yellow-500"></i></div>
                    <div class="w-12 h-12 rounded-xl bg-yellow-100 text-yellow-600 flex items-center justify-center mb-4"><i data-lucide="book-open" class="w-6 h-6"></i></div>
                    <h3 class="font-bold text-gray-800">Jurnal Guru</h3>
                    <p class="text-xs text-gray-500 mt-1">Catatan harian & bimbingan.</p>
                </div>

                <div onclick="nav('page-recap')" class="bg-white p-6 rounded-2xl shadow-sm hover:shadow-md transition cursor-pointer border border-gray-100 group relative overflow-hidden">
                    <div class="absolute right-[-10px] top-[-10px] opacity-5 transform rotate-12 transition group-hover:scale-110 group-hover:opacity-10"><i data-lucide="clipboard-list" class="w-32 h-32 text-emerald-500"></i></div>
                    <div class="w-12 h-12 rounded-xl bg-emerald-100 text-emerald-600 flex items-center justify-center mb-4"><i data-lucide="clipboard-list" class="w-6 h-6"></i></div>
                    <h3 class="font-bold text-gray-800">Rekap Jurnal</h3>
                    <p class="text-xs text-gray-500 mt-1">Laporan & Ekspor Data.</p>
                </div>
            </div>
        </div>
    </section>

    <!-- PAGE: PROGRAM -->
    <section id="page-program" class="hidden min-h-screen p-6">
        <div class="max-w-5xl mx-auto space-y-6">
            <div class="flex items-center justify-between">
                <h2 class="text-2xl font-bold text-gray-800">Program Kegiatan</h2>
                <button onclick="nav('page-home')" class="bg-white p-2 rounded-lg shadow text-gray-600 hover:bg-gray-50"><i data-lucide="home" class="w-5 h-5"></i></button>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <!-- Pillars -->
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 h-fit">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="font-bold text-purple-600">Pilar Program</h3>
                        <button onclick="editPillar()" class="p-1 hover:bg-purple-50 rounded text-purple-600"><i data-lucide="plus" class="w-4 h-4"></i></button>
                    </div>
                    <div id="pillar-list" class="space-y-3"></div>
                </div>

                <!-- Activities -->
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 md:col-span-2">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="font-bold text-purple-600">Bentuk Kegiatan</h3>
                        <button onclick="editActivity()" class="p-1 hover:bg-purple-50 rounded text-purple-600"><i data-lucide="plus" class="w-4 h-4"></i></button>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-left text-gray-600">
                            <tbody id="activity-list" class="divide-y divide-gray-100"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- PAGE: DAFTAR MURID -->
    <section id="page-students" class="hidden min-h-screen p-6">
        <div class="max-w-6xl mx-auto space-y-6">
            <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
                <h2 class="text-2xl font-bold text-gray-800">Daftar Murid</h2>
                <div class="flex gap-2">
                    <button onclick="openModal('cloudModal')" class="bg-blue-50 text-blue-600 px-3 py-2 rounded-lg text-sm font-medium hover:bg-blue-100 flex items-center gap-2"><i data-lucide="cloud" class="w-4 h-4"></i> Sync</button>
                    <button onclick="editStudent()" class="bg-pink-500 text-white px-3 py-2 rounded-lg text-sm font-medium hover:bg-pink-600 flex items-center gap-2"><i data-lucide="plus" class="w-4 h-4"></i> Baru</button>
                    <button onclick="nav('page-home')" class="bg-white p-2 rounded-lg shadow text-gray-600 hover:bg-gray-50"><i data-lucide="home" class="w-5 h-5"></i></button>
                </div>
            </div>

            <!-- Toolbar -->
            <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex flex-col md:flex-row gap-4 justify-between items-center">
                <div class="flex gap-2 w-full md:w-auto">
                    <input type="file" id="importFile" accept=".xlsx, .xls" class="hidden" onchange="importExcel(this)">
                    <button onclick="document.getElementById('importFile').click()" class="px-3 py-1.5 text-xs bg-gray-100 hover:bg-gray-200 rounded text-gray-700 flex items-center gap-1"><i data-lucide="upload" class="w-3 h-3"></i> Impor Excel</button>
                    <button onclick="exportExcelStudents()" class="px-3 py-1.5 text-xs bg-gray-100 hover:bg-gray-200 rounded text-gray-700 flex items-center gap-1"><i data-lucide="download" class="w-3 h-3"></i> Ekspor Excel</button>
                    <button onclick="bulkDeleteUI()" class="px-3 py-1.5 text-xs bg-red-50 hover:bg-red-100 text-red-600 rounded flex items-center gap-1"><i data-lucide="trash-2" class="w-3 h-3"></i> Hapus Massal</button>
                </div>
                <div class="flex items-center gap-2 w-full md:w-auto">
                    <span class="text-xs text-gray-500">Filter:</span>
                    <select id="filterYear" onchange="window.refreshUI()" class="text-sm bg-gray-50 border-none rounded p-1 focus:ring-0"></select>
                </div>
            </div>

            <!-- Grid -->
            <div id="student-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
        </div>
    </section>

    <!-- PAGE: JURNAL -->
    <section id="page-journal" class="hidden min-h-screen p-6">
        <div class="max-w-2xl mx-auto space-y-6">
            <div class="flex items-center justify-between">
                <h2 class="text-2xl font-bold text-gray-800">Jurnal Guru</h2>
                <button onclick="nav('page-home')" class="bg-white p-2 rounded-lg shadow text-gray-600 hover:bg-gray-50"><i data-lucide="home" class="w-5 h-5"></i></button>
            </div>

            <div class="bg-white p-6 rounded-2xl shadow-lg border-t-4 border-yellow-400">
                <form id="journalForm" onsubmit="handleJournalSubmit(event)" class="space-y-4">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Tanggal</label>
                            <input type="date" name="tanggal" required class="form-input text-sm">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Waktu (Format 24 Jam)</label>
                            <input type="time" name="waktu" required class="form-input text-sm">
                        </div>
                    </div>
                    <div>
                        <input type="text" id="jName" name="nama" list="dl_students" placeholder="Nama Murid..." class="form-input" onchange="autoFillJournal(this)">
                        <datalist id="dl_students"></datalist>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <input type="text" id="jClass" name="kelas" placeholder="Kelas" class="form-input text-sm">
                        <input type="text" id="jYear" name="academicYear" placeholder="Thn Ajaran" class="form-input text-sm">
                    </div>
                    <select name="jenis" class="form-input bg-white">
                        <option>Pendampingan Akademik</option>
                        <option>Pengembangan Kompetensi</option>
                        <option>Pengembangan Keterampilan</option>
                        <option>Pembentukan Karakter</option>
                    </select>
                    <textarea name="topik" rows="2" placeholder="Topik Permasalahan" class="form-input"></textarea>
                    <textarea name="tindak_lanjut" rows="2" placeholder="Tindak Lanjut" class="form-input"></textarea>
                    <button type="submit" class="w-full bg-yellow-400 hover:bg-yellow-500 text-yellow-900 font-bold py-3 rounded-xl transition shadow-md">Simpan Jurnal</button>
                </form>
            </div>
        </div>
    </section>

    <!-- PAGE: REKAP -->
    <section id="page-recap" class="hidden min-h-screen p-6">
        <div class="max-w-6xl mx-auto space-y-6">
            <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
                <h2 class="text-2xl font-bold text-gray-800">Rekap Jurnal</h2>
                <div class="flex gap-2">
                    <button onclick="exportRecapPDF()" class="bg-white text-red-600 border border-red-100 px-3 py-2 rounded-lg text-sm hover:bg-red-50 flex gap-2"><i data-lucide="file-text" class="w-4 h-4"></i> PDF</button>
                    <button onclick="exportRecapExcel()" class="bg-white text-green-600 border border-green-100 px-3 py-2 rounded-lg text-sm hover:bg-green-50 flex gap-2"><i data-lucide="sheet" class="w-4 h-4"></i> Excel</button>
                    <button onclick="nav('page-home')" class="bg-white p-2 rounded-lg shadow text-gray-600 hover:bg-gray-50"><i data-lucide="home" class="w-5 h-5"></i></button>
                </div>
            </div>

            <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left text-gray-600">
                        <thead class="bg-emerald-50 text-emerald-700 uppercase text-xs">
                            <tr>
                                <th class="px-4 py-3">No</th>
                                <th class="px-4 py-3">Waktu</th>
                                <th class="px-4 py-3">Nama</th>
                                <th class="px-4 py-3">Topik</th>
                                <th class="px-4 py-3">Tindak Lanjut</th>
                                <th class="px-4 py-3 text-right">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="recap-list" class="divide-y divide-gray-100 bg-white"></tbody>
                    </table>
                </div>
                <div id="recap-empty" class="p-8 text-center text-gray-400 text-sm hidden">Belum ada data jurnal.</div>
            </div>
        </div>
    </section>

    <!-- MODALS -->
    
    <!-- Student Modal -->
    <div id="modalStudent" class="fixed inset-0 z-[60] hidden bg-black/50 flex items-center justify-center p-4 backdrop-blur-sm" onclick="if(event.target===this) closeModal('modalStudent')">
        <div class="bg-white rounded-2xl w-full max-w-md p-6 shadow-2xl transform transition-all scale-100">
            <h3 class="text-lg font-bold mb-4" id="modalStudentTitle">Data Murid</h3>
            <input type="hidden" id="inpStudentId">
            <div class="space-y-3">
                <div class="flex items-center gap-4 mb-4">
                    <div class="w-16 h-16 rounded-full bg-gray-100 border flex-shrink-0 overflow-hidden relative">
                        <img id="inpStudentPhotoPreview" class="w-full h-full object-cover hidden">
                        <div id="inpStudentPhotoPlace" class="absolute inset-0 flex items-center justify-center text-gray-400"><i data-lucide="camera"></i></div>
                    </div>
                    <label class="cursor-pointer text-sm text-blue-600 font-medium hover:underline">
                        Upload Foto
                        <input type="file" id="inpStudentPhoto" class="hidden" accept="image/*" onchange="handlePhotoUpload(this)">
                    </label>
                </div>
                <input id="inpStudentName" class="form-input" placeholder="Nama Lengkap">
                <div class="grid grid-cols-2 gap-3">
                    <input id="inpStudentNISN" class="form-input" placeholder="NISN">
                    <input id="inpStudentClass" class="form-input" placeholder="Kelas">
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <input id="inpStudentPhone" class="form-input" placeholder="No HP/WA">
                    <input id="inpStudentYear" list="dl_years" class="form-input" placeholder="Thn Ajaran">
                    <datalist id="dl_years"><option value="2023/2024"><option value="2024/2025"><option value="2025/2026"></datalist>
                </div>
                <textarea id="inpStudentAddr" class="form-input" placeholder="Alamat" rows="2"></textarea>
            </div>
            <div class="mt-6 flex justify-end gap-2">
                <button onclick="closeModal('modalStudent')" class="px-4 py-2 text-gray-500 hover:bg-gray-100 rounded-lg text-sm">Batal</button>
                <button onclick="saveStudent()" id="btnSaveStudent" class="px-4 py-2 bg-blue-600 text-white rounded-lg text-sm hover:bg-blue-700 shadow">Simpan</button>
            </div>
        </div>
    </div>

    <!-- Cloud Modal -->
    <div id="cloudModal" class="fixed inset-0 z-[60] hidden bg-black/50 flex items-center justify-center p-4 backdrop-blur-sm" onclick="if(event.target===this) closeModal('cloudModal')">
        <div class="bg-white rounded-2xl w-full max-w-sm p-6 shadow-2xl">
            <div class="flex items-center gap-3 mb-4">
                <div class="bg-blue-100 p-2 rounded-full"><i data-lucide="cloud" class="w-5 h-5 text-blue-600"></i></div>
                <h3 class="font-bold">Sinkronisasi Cloud</h3>
            </div>
            <p class="text-xs text-gray-500 mb-4">Masukkan URL Google Apps Script Web App Anda untuk menyimpan data secara permanen di Google Sheet.</p>
            <input id="inpCloudUrl" class="form-input text-xs mb-4" placeholder="https://script.google.com/macros/s/...">
            <div class="grid grid-cols-2 gap-2 mb-4">
                <button onclick="cloudSync('pull')" class="py-2 bg-gray-100 hover:bg-gray-200 rounded text-xs font-medium flex justify-center gap-1"><i data-lucide="download" class="w-3 h-3"></i> Ambil Data</button>
                <button onclick="cloudSync('push')" class="py-2 bg-blue-50 hover:bg-blue-100 text-blue-600 rounded text-xs font-medium flex justify-center gap-1"><i data-lucide="upload" class="w-3 h-3"></i> Simpan Data</button>
            </div>
            <button onclick="saveCloudSettings()" class="w-full py-2 bg-blue-600 text-white rounded-lg text-sm hover:bg-blue-700">Simpan Pengaturan</button>
        </div>
    </div>

    <!-- JS LOGIC -->
    <script>
        // --- UI REFRESH LOGIC ---
        window.refreshUI = () => {
            // Update Students Grid
            const grid = document.getElementById('student-grid');
            const filterYear = document.getElementById('filterYear');
            const currentFilter = filterYear.value;
            
            // Populate Filters
            const years = [...new Set(window.students.map(s => s.academicYear || '-'))].sort().reverse();
            filterYear.innerHTML = '<option value="all">Semua Tahun</option>' + years.map(y => `<option value="${y}" ${currentFilter===y?'selected':''}>${y}</option>`).join('');

            // Filter Data
            const filtered = window.students.filter(s => filterYear.value === 'all' || s.academicYear === filterYear.value);
            
            if(filtered.length === 0) {
                grid.innerHTML = '<div class="col-span-full text-center py-10 text-gray-400">Belum ada data murid.</div>';
            } else {
                grid.innerHTML = filtered.map(s => `
                    <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 hover:shadow-md transition flex items-start gap-4 group">
                        <div class="w-12 h-12 rounded-full bg-gray-100 flex-shrink-0 overflow-hidden">
                            ${s.photo ? `<img src="${s.photo}" class="w-full h-full object-cover">` : `<div class="w-full h-full flex items-center justify-center text-gray-400"><i data-lucide="user"></i></div>`}
                        </div>
                        <div class="flex-1 min-w-0">
                            <h4 class="font-bold text-gray-800 truncate">${s.name}</h4>
                            <p class="text-xs text-pink-500 font-medium">${s.class} <span class="text-gray-300">|</span> ${s.academicYear}</p>
                            <p class="text-[10px] text-gray-400 mt-1 truncate">NISN: ${s.nisn || '-'}</p>
                        </div>
                        <div class="flex flex-col gap-1 opacity-0 group-hover:opacity-100 transition">
                            <button onclick="editStudent('${s.id}')" class="p-1 text-blue-500 hover:bg-blue-50 rounded"><i data-lucide="pencil" class="w-3 h-3"></i></button>
                            <button onclick="window.dbDeleteStudent('${s.id}')" class="p-1 text-red-500 hover:bg-red-50 rounded"><i data-lucide="trash-2" class="w-3 h-3"></i></button>
                        </div>
                    </div>
                `).join('');
            }

            // Update Journal Datalist
            document.getElementById('dl_students').innerHTML = window.students.map(s => `<option value="${s.name}">`).join('');

            // Update Recap Table
            const tbody = document.getElementById('recap-list');
            const empty = document.getElementById('recap-empty');
            if(window.journals.length === 0) {
                tbody.innerHTML = ''; empty.classList.remove('hidden');
            } else {
                empty.classList.add('hidden');
                tbody.innerHTML = window.journals.map((j, i) => `
                    <tr class="hover:bg-gray-50">
                        <td class="px-4 py-2 font-bold text-emerald-600">${window.journals.length - i}</td>
                        <td class="px-4 py-2 text-xs"><div>${j.tanggal}</div><div class="text-gray-400">${j.waktu}</div></td>
                        <td class="px-4 py-2 font-medium">${j.nama}</td>
                        <td class="px-4 py-2 text-xs text-gray-500 max-w-[150px] truncate">${j.topik}</td>
                        <td class="px-4 py-2 text-xs text-gray-500 max-w-[150px] truncate">${j.tindak_lanjut}</td>
                        <td class="px-4 py-2 text-right">
                            <button onclick="editJournal('${j.id}')" class="text-blue-500 hover:underline text-xs mr-2">Edit</button>
                            <button onclick="window.dbDeleteJournal('${j.id}')" class="text-red-500 hover:underline text-xs">Hapus</button>
                        </td>
                    </tr>
                `).join('');
            }

            // Update Program Lists
            document.getElementById('pillar-list').innerHTML = window.pillars.map((p, i) => 
                `<div class="flex justify-between items-center bg-gray-50 p-2 rounded border border-gray-100 group">
                    <span class="text-sm flex items-center gap-2"><i data-lucide="${p.icon}" class="w-4 h-4 text-purple-500"></i> ${p.name}</span>
                    <div class="hidden group-hover:flex gap-1"><button onclick="editPillar(${i})" class="text-xs text-blue-500">Edit</button><button onclick="deletePillar(${i})" class="text-xs text-red-500">Hapus</button></div>
                </div>`
            ).join('');
            
            document.getElementById('activity-list').innerHTML = window.activities.map((a, i) => 
                `<tr class="hover:bg-gray-50 group">
                    <td class="px-4 py-2 w-8 text-center text-purple-500 font-bold">${i+1}</td>
                    <td class="px-4 py-2">${a}</td>
                    <td class="px-4 py-2 w-16 text-center opacity-0 group-hover:opacity-100">
                        <button onclick="deleteActivity(${i})" class="text-red-500"><i data-lucide="trash-2" class="w-3 h-3"></i></button>
                    </td>
                </tr>`
            ).join('');

            // Re-init icons & date
            lucide.createIcons();
            const d = new Date();
            document.getElementById('current-date').textContent = d.toLocaleDateString('id-ID', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });
        }

        // --- NAVIGATION ---
        window.nav = (id) => {
            document.querySelectorAll('section').forEach(s => s.classList.add('hidden'));
            const el = document.getElementById(id);
            el.classList.remove('hidden');
            window.scrollTo(0,0);
            
            // Add specific logic for Journal page
            if (id === 'page-journal') {
                const now = new Date();
                const dateStr = now.toISOString().split('T')[0];
                // HH:mm format (24h)
                const timeStr = now.toTimeString().slice(0,5); 
                
                const form = document.getElementById('journalForm');
                if(!form.querySelector('[name="tanggal"]').value) form.querySelector('[name="tanggal"]').value = dateStr;
                if(!form.querySelector('[name="waktu"]').value) form.querySelector('[name="waktu"]').value = timeStr;
            }

            window.refreshUI();
        };

        // --- MODAL LOGIC ---
        window.openModal = (id) => {
            document.getElementById(id).classList.remove('hidden');
            if(id === 'cloudModal') document.getElementById('inpCloudUrl').value = localStorage.getItem('guruWali_cloudUrl') || '';
        };
        window.closeModal = (id) => document.getElementById(id).classList.add('hidden');

        // --- STUDENT LOGIC ---
        window.editStudent = (id) => {
            const s = id ? window.students.find(x => x.id === id) : null;
            document.getElementById('inpStudentId').value = id || '';
            document.getElementById('inpStudentName').value = s ? s.name : '';
            document.getElementById('inpStudentNISN').value = s ? s.nisn : '';
            document.getElementById('inpStudentClass').value = s ? s.class : '';
            document.getElementById('inpStudentPhone').value = s ? s.phone : '';
            document.getElementById('inpStudentYear').value = s ? s.academicYear : '2024/2025';
            document.getElementById('inpStudentAddr').value = s ? s.address : '';
            
            const prev = document.getElementById('inpStudentPhotoPreview');
            const place = document.getElementById('inpStudentPhotoPlace');
            if (s && s.photo) { prev.src = s.photo; prev.classList.remove('hidden'); place.classList.add('hidden'); }
            else { prev.classList.add('hidden'); place.classList.remove('hidden'); prev.src = ''; }
            
            // Clear file input
            document.getElementById('inpStudentPhoto').value = '';
            
            openModal('modalStudent');
        };

        window.handlePhotoUpload = (input) => {
            if(input.files && input.files[0]) {
                const file = input.files[0];
                if(file.size > 500 * 1024) { alert("Ukuran foto maksimal 500KB!"); input.value=''; return; }
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.src = e.target.result;
                    img.onload = () => {
                        const cvs = document.createElement('canvas');
                        const ctx = cvs.getContext('2d');
                        const scale = Math.min(300/img.width, 300/img.height);
                        cvs.width = img.width * scale; cvs.height = img.height * scale;
                        ctx.drawImage(img, 0, 0, cvs.width, cvs.height);
                        const base64 = cvs.toDataURL('image/jpeg', 0.7);
                        document.getElementById('inpStudentPhotoPreview').src = base64;
                        document.getElementById('inpStudentPhotoPreview').classList.remove('hidden');
                        document.getElementById('inpStudentPhotoPlace').classList.add('hidden');
                        input.dataset.val = base64;
                    }
                };
                reader.readAsDataURL(file);
            }
        };

        window.saveStudent = async () => {
            const btn = document.getElementById('btnSaveStudent');
            btn.innerText = "Menyimpan..."; btn.disabled = true;
            
            const id = document.getElementById('inpStudentId').value;
            const photoInput = document.getElementById('inpStudentPhoto');
            let photo = photoInput.dataset.val; // New photo
            
            if (!photo && id) { // Keep old photo
                const s = window.students.find(x => x.id === id);
                if(s) photo = s.photo;
            }

            const data = {
                name: document.getElementById('inpStudentName').value,
                nisn: document.getElementById('inpStudentNISN').value,
                class: document.getElementById('inpStudentClass').value,
                phone: document.getElementById('inpStudentPhone').value,
                academicYear: document.getElementById('inpStudentYear').value,
                address: document.getElementById('inpStudentAddr').value,
                photo: photo || null
            };

            await window.dbSaveStudent(data, id || null);
            btn.innerText = "Simpan"; btn.disabled = false;
            closeModal('modalStudent');
            toast("Berhasil", "Data murid tersimpan.", "success");
        };

        // --- JOURNAL LOGIC ---
        window.autoFillJournal = (input) => {
            const s = window.students.find(x => x.name === input.value);
            if(s) {
                document.getElementById('jClass').value = s.class || '';
                document.getElementById('jYear').value = s.academicYear || '';
            }
        };

        window.handleJournalSubmit = async (e) => {
            e.preventDefault();
            const form = e.target;
            const data = Object.fromEntries(new FormData(form).entries());
            await window.dbSaveJournal(data, null);
            form.reset();
            nav('page-recap');
            toast("Tersimpan", "Jurnal berhasil ditambahkan.", "success");
        };

        window.editJournal = (id) => {
            // Logic to populate form for editing (Simplified: just alert for now, fully implementing needs modal like student)
            // For MVP: Delete and Re-add is easier, or use the form to update.
            const j = window.journals.find(x => x.id === id);
            if(j) {
                // Populate main form and switch view
                const form = document.getElementById('journalForm');
                form.querySelector('[name="tanggal"]').value = j.tanggal;
                form.querySelector('[name="waktu"]').value = j.waktu;
                form.querySelector('[name="nama"]').value = j.nama;
                form.querySelector('[name="kelas"]').value = j.kelas;
                form.querySelector('[name="academicYear"]').value = j.academicYear || '';
                form.querySelector('[name="jenis"]').value = j.jenis;
                form.querySelector('[name="topik"]').value = j.topik;
                form.querySelector('[name="tindak_lanjut"]').value = j.tindak_lanjut;
                
                nav('page-journal');
                window.dbDeleteJournal(id); // Remove old so save creates "updated" one.
                toast("Mode Edit", "Silakan ubah dan simpan kembali.", "info");
            }
        };

        // --- PROGRAM LOGIC ---
        window.editPillar = (idx) => {
            const p = window.pillars[idx];
            const newName = prompt("Nama Pilar:", p?.name);
            if(newName) {
                if(idx === undefined || idx === null) window.pillars.push({ name: newName, icon: 'star' });
                else window.pillars[idx].name = newName;
                window.dbSaveProgram('pillars', window.pillars);
            }
        };
        window.deletePillar = (idx) => {
            if(confirm("Hapus pilar ini?")) {
                window.pillars.splice(idx, 1);
                window.dbSaveProgram('pillars', window.pillars);
            }
        };
        window.editActivity = () => {
            const desc = prompt("Deskripsi Kegiatan:");
            if(desc) {
                window.activities.push(desc);
                window.dbSaveProgram('activities', window.activities);
            }
        };
        window.deleteActivity = (idx) => {
            if(confirm("Hapus kegiatan ini?")) {
                window.activities.splice(idx, 1);
                window.dbSaveProgram('activities', window.activities);
            }
        };

        // --- IMPORT/EXPORT/BULK ---
        window.exportExcelStudents = () => {
            const ws = XLSX.utils.json_to_sheet(window.students.map((s, i) => ({ No: i+1, ...s })));
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Murid");
            XLSX.writeFile(wb, "Data_Murid.xlsx");
        };

        window.importExcel = (input) => {
            const file = input.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = async (e) => {
                const wb = XLSX.read(e.target.result, {type:'array'});
                const json = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
                let count = 0;
                for (const row of json) {
                    const s = {
                        id: Date.now() + Math.random().toString(),
                        name: row['Nama'] || row['Nama Lengkap'] || '',
                        class: row['Kelas'] || '',
                        nisn: row['NISN'] || '',
                        phone: row['HP'] || '',
                        address: row['Alamat'] || '',
                        academicYear: row['Tahun Ajaran'] || '2024/2025'
                    };
                    if(s.name) { await window.dbSaveStudent(s, null); count++; }
                }
                toast("Selesai", `${count} data diimpor.`, "success");
            };
            reader.readAsArrayBuffer(file);
        };

        window.bulkDeleteUI = async () => {
            const year = prompt("Masukkan Tahun Ajaran yang akan dihapus (misal: 2023/2024):");
            if(!year) return;
            const toDelete = window.students.filter(s => s.academicYear === year).map(s => s.id);
            if(toDelete.length > 0 && confirm(`Yakin hapus ${toDelete.length} data murid tahun ${year}?`)) {
                await window.dbBulkDeleteStudents(toDelete);
                toast("Selesai", "Data berhasil dihapus.", "success");
            } else {
                alert("Tidak ada data ditemukan.");
            }
        };

        // --- CLOUD SYNC ---
        window.saveCloudSettings = () => {
            const url = document.getElementById('inpCloudUrl').value;
            localStorage.setItem('guruWali_cloudUrl', url);
            closeModal('cloudModal');
            toast("Tersimpan", "URL Cloud diperbarui.", "success");
        };

        window.cloudSync = (action) => {
            const url = localStorage.getItem('guruWali_cloudUrl');
            if (!url) { Swal.fire('Error', 'Masukkan URL Google Apps Script terlebih dahulu di pengaturan!', 'error'); return; }
            
            // Find button safely
            const btn = event.target.tagName === 'BUTTON' ? event.target : event.target.closest('button');
            const originalText = btn.innerHTML;
            btn.innerHTML = `<i class="animate-spin" data-lucide="loader-2"></i> ${action === 'push' ? 'Mengirim...' : 'Mengambil...'}`; 
            btn.disabled = true;
            lucide.createIcons();

            if (action === 'push') {
                // PUSH: Kirim data ke Google Sheet
                // Menggunakan text/plain untuk menghindari Preflight CORS Check
                const payload = JSON.stringify({ 
                    students: window.students, 
                    journals: window.journals,
                    pillars: window.pillars,
                    activities: window.activities
                });

                fetch(url, {
                    method: 'POST',
                    mode: 'no-cors', // Penting agar tidak blocked browser
                    headers: { 'Content-Type': 'text/plain' },
                    body: payload
                }).then(() => {
                    // Karena no-cors, kita tidak bisa baca response status. Asumsikan berhasil jika fetch selesai.
                    Swal.fire('Berhasil', 'Data dikirim ke Google Sheet (Background Process). Tunggu beberapa saat sebelum cek sheet.', 'success');
                }).catch(e => {
                    console.error(e);
                    Swal.fire('Gagal', 'Gagal terhubung ke server: ' + e, 'error');
                }).finally(() => { 
                    btn.innerHTML = originalText; 
                    btn.disabled = false; 
                    lucide.createIcons();
                });

            } else {
                // PULL: Ambil data dari Google Sheet
                fetch(url)
                .then(res => res.json())
                .then(data => {
                    if(data.status === 'success' || data.students) {
                        // Restore Data
                        if(data.students) window.students = data.students;
                        if(data.journals) window.journals = data.journals;
                        if(data.pillars) window.pillars = data.pillars;
                        if(data.activities) window.activities = data.activities;

                        // Save to LocalStorage
                        localStorage.setItem('guruWali_students', JSON.stringify(window.students));
                        localStorage.setItem('guruWali_journals', JSON.stringify(window.journals));
                        localStorage.setItem('guruWali_pillars', JSON.stringify(window.pillars));
                        localStorage.setItem('guruWali_activities', JSON.stringify(window.activities));
                        
                        window.refreshUI();
                        Swal.fire('Berhasil', `Data dipulihkan:\n${window.students.length} Murid\n${window.journals.length} Jurnal`, 'success');
                    } else {
                        Swal.fire('Info', 'Format data tidak dikenali atau kosong.', 'info');
                    }
                })
                .catch(e => {
                    console.error(e);
                    Swal.fire('Gagal', 'Gagal mengambil data. Pastikan URL benar dan deployment diset ke "Anyone".', 'error');
                })
                .finally(() => { 
                    btn.innerHTML = originalText; 
                    btn.disabled = false; 
                    lucide.createIcons();
                });
            }
        };

        // --- UTILS ---
        function toast(t, m, type) {
            const el = document.getElementById('toast');
            el.querySelector('h4').textContent = t;
            el.querySelector('p').textContent = m;
            document.getElementById('toast-icon').innerHTML = type==='success' ? '<i data-lucide="check-circle" class="text-green-500"></i>' : '<i data-lucide="alert-circle" class="text-red-500"></i>';
            el.classList.remove('translate-x-full', 'opacity-0');
            setTimeout(() => el.classList.add('translate-x-full', 'opacity-0'), 3000);
            lucide.createIcons();
        }
    </script>
</body>
</html>
